import os
import sys
import json
import datetime
import threading
import concurrent.futures
import time
import traceback
import logging
import types
from requests.exceptions import ReadTimeout, ProxyError, ConnectionError

# ØªÙ†Ø¸ÛŒÙ… Ù„Ø§Ú¯Ø± Ø§ØµÙ„ÛŒ
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.DEBUG
)
logger = logging.getLogger(__name__)

# ÙˆØ§Ø±Ø¯Ú©Ø±Ø¯Ù† Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ
try:
    # Ø³ÛŒØ³ØªÙ… Ù„Ø§Ú¯ÛŒÙ†Ú¯ Ù¾ÛŒØ´Ø±ÙØªÙ‡
    from debug_logger import debug_log, log_webhook_request, log_telegram_update, debug_decorator, format_exception_with_context
    logger.info("âœ… Ø³ÛŒØ³ØªÙ… Ø¯ÛŒØ¨Ø§Ú¯ÛŒÙ†Ú¯ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯")
except ImportError as e:
    logger.error(f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø§Ú˜ÙˆÙ„ debug_logger: {e}")
    # ØªØ¹Ø±ÛŒÙ ØªÙˆØ§Ø¨Ø¹ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ† Ø¯Ø± ØµÙˆØ±Øª Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…Ø§Ú˜ÙˆÙ„ Ø¯ÛŒØ¨Ø§Ú¯ÛŒÙ†Ú¯
    def debug_log(message, level="DEBUG", context=None):
        logger.debug(f"{message} - Context: {context}")

    def log_webhook_request(data):
        if isinstance(data, bytes):
            data_str = data.decode('utf-8')
        else:
            data_str = str(data)
        logger.debug(f"Webhook data: {data_str[:200]}...")

    def log_telegram_update(update):
        logger.debug(f"Telegram update: {update}")

    def debug_decorator(func):
        return func

    def format_exception_with_context(e):
        return traceback.format_exc()

# ÙˆØ§Ø±Ø¯Ú©Ø±Ø¯Ù† Ù…Ø§Ú˜ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ø®Ø§Ø±Ø¬ÛŒ Ø¨Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§
try:
    import telebot
    logger.info("âœ… Ù…Ø§Ú˜ÙˆÙ„ telebot Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯")
except ImportError:
    logger.error("âš ï¸ Ù…Ø§Ú˜ÙˆÙ„ telebot Ù†ØµØ¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª")
    exit(1)

try:
    from flask import Flask, request
    logger.info("âœ… Ù…Ø§Ú˜ÙˆÙ„ flask Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯")
except ImportError:
    logger.error("âš ï¸ Ù…Ø§Ú˜ÙˆÙ„ flask Ù†ØµØ¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª")

try:
    import shutil  # Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Ø¯ÛŒØ³Ú©
    logger.info("âœ… Ù…Ø§Ú˜ÙˆÙ„ shutil Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯")
except ImportError:
    logger.error("âš ï¸ Ù…Ø§Ú˜ÙˆÙ„ shutil Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª")

try:
    import psutil  # Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª CPU Ùˆ RAM
    logger.info("âœ… Ù…Ø§Ú˜ÙˆÙ„ psutil Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯")
except ImportError:
    logger.error("âš ï¸ Ù…Ø§Ú˜ÙˆÙ„ psutil Ù†ØµØ¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª")

try:
    import platform  # Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÛŒØ³ØªÙ…â€ŒØ¹Ø§Ù…Ù„
    logger.info("âœ… Ù…Ø§Ú˜ÙˆÙ„ platform Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯")
except ImportError:
    logger.error("âš ï¸ Ù…Ø§Ú˜ÙˆÙ„ platform Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª")

try:
    import sqlite3
    logger.info("âœ… Ù…Ø§Ú˜ÙˆÙ„ sqlite3 Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯")
except ImportError:
    logger.error("âš ï¸ Ù…Ø§Ú˜ÙˆÙ„ sqlite3 Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª")

try:
    from yt_dlp import YoutubeDL
    logger.info("âœ… Ù…Ø§Ú˜ÙˆÙ„ yt_dlp Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯")
except ImportError:
    logger.error("âš ï¸ Ù…Ø§Ú˜ÙˆÙ„ yt_dlp Ù†ØµØ¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª")

app = Flask(__name__)

# Ø§ÛŒØ¬Ø§Ø¯ Ø§Ø³ØªØ®Ø± ØªØ±Ø¯ Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù† ÙØ±Ø§ÛŒÙ†Ø¯Ù‡Ø§ Ø¨Ø§ ØªØ¹Ø¯Ø§Ø¯ Ø¨Ù‡ÛŒÙ†Ù‡
thread_pool = concurrent.futures.ThreadPoolExecutor(max_workers=2)  # Ú©Ø§Ù‡Ø´ ØªØ¹Ø¯Ø§Ø¯ ØªØ±Ø¯â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù‡Ø´ Ù…ØµØ±Ù Ù…Ù†Ø§Ø¨Ø¹


# Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¨â€ŒÙ‡ÙˆÚ© Ø§Ø² ÙÙ„Ø³Ú© Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
@debug_decorator
def webhook():
    json_str = None
    debug_log("Ø´Ø±ÙˆØ¹ Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¨â€ŒÙ‡ÙˆÚ© Ø¬Ø¯ÛŒØ¯", "INFO")

    try:
        # Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø² Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§
        try:
            json_raw = request.get_data()
            debug_log(f"Ø¯Ø§Ø¯Ù‡ Ø®Ø§Ù… ÙˆØ¨â€ŒÙ‡ÙˆÚ© Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯: {len(json_raw)} Ø¨Ø§ÛŒØª", "DEBUG")

            # ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø±Ù…Ø²Ú¯Ø´Ø§ÛŒÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
            try:
                json_str = json_raw.decode("UTF-8")
            except UnicodeDecodeError:
                # Ø§Ú¯Ø± UTF-8 Ú©Ø§Ø± Ù†Ú©Ø±Ø¯ØŒ Ø±ÙˆØ´â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø± Ø±Ø§ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†
                try:
                    json_str = json_raw.decode("latin-1")
                    debug_log("Ø¯Ø§Ø¯Ù‡ ÙˆØ¨â€ŒÙ‡ÙˆÚ© Ø¨Ø§ latin-1 Ø±Ù…Ø²Ú¯Ø´Ø§ÛŒÛŒ Ø´Ø¯", "WARNING")
                except Exception:
                    # Ø§Ú¯Ø± Ù‡Ù…Ù‡ Ø±ÙˆØ´â€ŒÙ‡Ø§ Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯ØŒ ÙÙ‚Ø· Ø¯Ø§Ø¯Ù‡ Ø¨Ø§ÛŒÙ†Ø±ÛŒ Ø±Ø§ Ù„Ø§Ú¯ Ú©Ù†
                    debug_log("Ø¹Ø¯Ù… ØªÙˆØ§Ù†Ø§ÛŒÛŒ Ø¯Ø± Ø±Ù…Ø²Ú¯Ø´Ø§ÛŒÛŒ Ø¯Ø§Ø¯Ù‡ ÙˆØ¨â€ŒÙ‡ÙˆÚ©", "ERROR")
                    log_webhook_request(json_raw)
                    return "Ø®Ø·Ø§ÛŒ Ø±Ù…Ø²Ú¯Ø´Ø§ÛŒÛŒ Ø¯Ø§Ø¯Ù‡", 400

            # Ù„Ø§Ú¯ Ú©Ø±Ø¯Ù† Ø¨Ø®Ø´ÛŒ Ø§Ø² Ø¯Ø§Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØªÛŒ
            if json_str:
                preview = json_str[:100] + ("..." if len(json_str) > 100 else "")
                debug_log(f"Ø¯Ø§Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØªÛŒ ÙˆØ¨â€ŒÙ‡ÙˆÚ©: {preview}", "INFO")
                log_webhook_request(json_str)

        except Exception as req_error:
            debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡ Ø§Ø² Ø¯Ø±Ø®ÙˆØ§Ø³Øª ÙˆØ¨â€ŒÙ‡ÙˆÚ©", "ERROR", {
                "error_type": type(req_error).__name__,
                "error_message": str(req_error)
            })
            return "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª", 400

        # ØªØ¨Ø¯ÛŒÙ„ JSON Ø¨Ù‡ Ø¢Ø¨Ø¬Ú©Øª Update ØªÙ„Ú¯Ø±Ø§Ù… Ø¨Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§
        try:
            # Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø¯Ù‡
            if not json_str:
                debug_log("JSON Ø®Ø§Ù„ÛŒ ÛŒØ§ Ù†Ø§Ù…Ø¹ØªØ¨Ø±", "ERROR")
                return "Ø¯Ø§Ø¯Ù‡ JSON Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª", 400

            # ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ø¢Ø¨Ø¬Ú©Øª Update
            try:
                update = telebot.types.Update.de_json(json_str)
                if not update:
                    debug_log("ØªØ¨Ø¯ÛŒÙ„ JSON Ø¨Ù‡ Ø¢Ø¨Ø¬Ú©Øª Update Ø¨Ø§ Ù…Ø´Ú©Ù„ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯", "ERROR")
                    return "ØªØ¨Ø¯ÛŒÙ„ JSON Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯", 400
            except Exception as json_error:
                debug_log(f"Ø®Ø·Ø§ Ø¯Ø± ØªØ¨Ø¯ÛŒÙ„ JSON Ø¨Ù‡ Ø¢Ø¨Ø¬Ú©Øª Update", "ERROR", {
                    "error_type": type(json_error).__name__,
                    "error_message": str(json_error),
                    "json_sample": json_str[:200] if json_str else "None"
                })
                return "Ø®Ø·Ø§ Ø¯Ø± ØªØ¨Ø¯ÛŒÙ„ JSON", 400

            # Ø«Ø¨Øª Ø¢Ù¾Ø¯ÛŒØª ØªÙ„Ú¯Ø±Ø§Ù… Ø¯Ø± Ù„Ø§Ú¯ Ø¨Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§
            try:
                log_telegram_update(update)
            except Exception as log_error:
                debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ù„Ø§Ú¯ Ú©Ø±Ø¯Ù† Ø¢Ù¾Ø¯ÛŒØª ØªÙ„Ú¯Ø±Ø§Ù…", "ERROR", {
                    "error_type": type(log_error).__name__,
                    "error_message": str(log_error)
                })
                # Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ… Ø­ØªÛŒ Ø§Ú¯Ø± Ù„Ø§Ú¯ÛŒÙ†Ú¯ Ø®Ø·Ø§ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯

            # Ø¨Ø±Ø±Ø³ÛŒ Ù†ÙˆØ¹ Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ Ù„Ø§Ú¯ Ø¨Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§
            try:
                if hasattr(update, 'message') and update.message is not None:
                    user_id = None
                    msg_text = None

                    # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§
                    try:
                        if hasattr(update.message, 'from_user') and update.message.from_user is not None:
                            user_id = update.message.from_user.id
                            username = update.message.from_user.username if hasattr(update.message.from_user, 'username') else None
                    except Exception:
                        debug_log("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±", "WARNING")

                    # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø¨Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§
                    try:
                        msg_text = update.message.text if hasattr(update.message, 'text') else "[NO_TEXT]"
                    except Exception:
                        debug_log("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ØªÙ† Ù¾ÛŒØ§Ù…", "WARNING")
                        msg_text = "[ERROR_EXTRACTING_TEXT]"

                    # Ù„Ø§Ú¯ Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù…
                    log_data = {
                        "user_id": user_id,
                        "chat_id": update.message.chat.id if hasattr(update.message, 'chat') and hasattr(update.message.chat, 'id') else None,
                        "message_id": update.message.message_id if hasattr(update.message, 'message_id') else None
                    }

                    # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ÛŒÙˆØ²Ø±Ù†ÛŒÙ… Ø§Ú¯Ø± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ø¯
                    if hasattr(update.message, 'from_user') and update.message.from_user and hasattr(update.message.from_user, 'username'):
                        log_data["username"] = update.message.from_user.username

                    debug_log(f"Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø§Ø² Ú©Ø§Ø±Ø¨Ø± {user_id}: {msg_text}", "INFO", log_data)

                elif hasattr(update, 'callback_query') and update.callback_query is not None:
                    # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù„Ø¨Ú© Ú©ÙˆØ¦Ø±ÛŒ Ø¨Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§
                    callback_info = {}

                    try:
                        if hasattr(update.callback_query, 'from_user') and update.callback_query.from_user:
                            callback_info["user_id"] = update.callback_query.from_user.id
                    except Exception:
                        debug_log("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ú©Ø§Ù„Ø¨Ú© Ú©ÙˆØ¦Ø±ÛŒ", "WARNING")
                        callback_info["user_id"] = None

                    try:
                        callback_info["query_id"] = update.callback_query.id if hasattr(update.callback_query, 'id') else None
                    except Exception:
                        debug_log("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ù„Ø¨Ú© Ú©ÙˆØ¦Ø±ÛŒ", "WARNING")

                    try:
                        callback_info["data"] = update.callback_query.data if hasattr(update.callback_query, 'data') else None
                    except Exception:
                        debug_log("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¯Ø§Ø¯Ù‡ Ú©Ø§Ù„Ø¨Ú© Ú©ÙˆØ¦Ø±ÛŒ", "WARNING")

                    # Ù„Ø§Ú¯ Ú©Ø±Ø¯Ù† Ú©Ø§Ù„Ø¨Ú© Ú©ÙˆØ¦Ø±ÛŒ
                    user_id_str = str(callback_info.get("user_id", "Ù†Ø§Ù…Ø´Ø®Øµ"))
                    debug_log(f"Ú©Ø§Ù„Ø¨Ú© Ú©ÙˆØ¦Ø±ÛŒ Ø¬Ø¯ÛŒØ¯ Ø§Ø² Ú©Ø§Ø±Ø¨Ø± {user_id_str}", "INFO", callback_info)
            except Exception as msg_log_error:
                debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ù„Ø§Ú¯ Ú©Ø±Ø¯Ù† Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾ÛŒØ§Ù…", "ERROR", {
                    "error_type": type(msg_log_error).__name__,
                    "error_message": str(msg_log_error)
                })
                # Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ… Ø­ØªÛŒ Ø§Ú¯Ø± Ù„Ø§Ú¯ÛŒÙ†Ú¯ Ø®Ø·Ø§ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯

            # Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù… Ø¨Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§
            try:
                bot.process_new_updates([update])
                debug_log("Ù¾ÛŒØ§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯", "INFO")
                return "âœ… Webhook Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯!", 200
            except Exception as process_error:
                error_details = format_exception_with_context(process_error)
                debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù… ØªÙˆØ³Ø· Ø±Ø¨Ø§Øª", "ERROR", {
                    "error_type": type(process_error).__name__,
                    "error_message": str(process_error),
                    "traceback": error_details
                })

                # Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† Ø¨Ø§ Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø·ÙˆÙ„ Ù¾ÛŒØ§Ù…
                try:
                    notify_admin(f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù…:\n{str(process_error)}\n\n{error_details[:2000]}...")
                except Exception:
                    debug_log("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†", "ERROR")

                return f"Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù…", 500

        except Exception as update_error:
            error_details = format_exception_with_context(update_error)
            debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¢Ù¾Ø¯ÛŒØª ØªÙ„Ú¯Ø±Ø§Ù…", "ERROR", {
                "error_type": type(update_error).__name__,
                "error_message": str(update_error),
                "traceback": error_details
            })

            # Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†
            try:
                notify_admin(f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¢Ù¾Ø¯ÛŒØª:\n{str(update_error)}\n\n{error_details[:2000]}...")
            except Exception:
                debug_log("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†", "ERROR")

            return f"Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¢Ù¾Ø¯ÛŒØª", 500

    except Exception as e:
        # Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø± Ú¯ÙˆÙ†Ù‡ Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡
        try:
            error_details = format_exception_with_context(e)
            debug_log(f"Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙˆØ¨â€ŒÙ‡ÙˆÚ©", "ERROR", {
                "error_type": type(e).__name__,
                "error_message": str(e),
                "traceback": error_details
            })

            # Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†
            try:
                notify_admin(f"âš ï¸ Ø®Ø·Ø§ÛŒ ØºÛŒØ±Ù…Ù†ØªØ¸Ø±Ù‡ Ø¯Ø± ÙˆØ¨â€ŒÙ‡ÙˆÚ©:\n{str(e)}\n\n{error_details[:2000]}...")
            except Exception:
                debug_log("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†", "ERROR")

        except Exception as logging_error:
            # Ø§Ú¯Ø± Ø­ØªÛŒ Ù„Ø§Ú¯ÛŒÙ†Ú¯ Ù‡Ù… Ø®Ø·Ø§ Ø¯Ø§Ø´ØªØŒ ÛŒÚ© Ù¾ÛŒØ§Ù… Ø³Ø§Ø¯Ù‡ Ø«Ø¨Øª Ú©Ù†
            print(f"Critical error in webhook handler: {str(e)} - Logging error: {str(logging_error)}")

        return f"Ø®Ø·Ø§ÛŒ Ø³Ø±ÙˆØ±", 500


SERVER_CACHE = {"status": None, "timestamp": None}


def get_cached_server_status():
    """Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ± Ø§Ø² Ú©Ø´ Ø¨Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§ÛŒ Ø¨Ù‡ØªØ±"""
    global SERVER_CACHE

    # Ø§Ú¯Ø± ÙˆØ¶Ø¹ÛŒØª Ø¯Ø± Ú©Ø´ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ø¯ Ùˆ Ú©Ù…ØªØ± Ø§Ø² 10 Ø¯Ù‚ÛŒÙ‚Ù‡ (600 Ø«Ø§Ù†ÛŒÙ‡) Ø§Ø² Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú¯Ø°Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
    try:
        if SERVER_CACHE["status"] is not None and SERVER_CACHE["timestamp"] is not None:
            time_diff = (datetime.datetime.now() - SERVER_CACHE["timestamp"]).total_seconds()
            if time_diff < 600:
                return SERVER_CACHE["status"]
    except Exception as e:
        print(f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø´: {e}")

    # Ø§Ú¯Ø± ÙˆØ¶Ø¹ÛŒØª Ø¯Ø± Ú©Ø´ Ù†Ø¨Ø§Ø´Ø¯ ÛŒØ§ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯ØŒ Ø§Ø² ÙØ§ÛŒÙ„ Ø¨Ø®ÙˆØ§Ù†
    if os.path.exists("server_status.json"):
        try:
            with open("server_status.json", "r", encoding="utf-8") as file:
                data = json.load(file)

                if "status" in data and "timestamp" in data:
                    try:
                        timestamp = datetime.datetime.strptime(data["timestamp"], "%Y-%m-%d %H:%M:%S")
                        SERVER_CACHE["status"] = data["status"]
                        SERVER_CACHE["timestamp"] = timestamp
                        return data["status"]
                    except ValueError as e:
                        print(f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± ØªØ¨Ø¯ÛŒÙ„ ØªØ§Ø±ÛŒØ®: {e}")
                        return None
                else:
                    return None
        except Exception as e:
            print(f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† ÙØ§ÛŒÙ„ Ú©Ø´: {e}")
            return None
    return None


MESSAGES_DB_TEXT = "channel_messages.json"
MESSAGES_DB_LINKS = "channel_links.json"
MAX_MESSAGES = 100000  # Ø­Ø¯Ø§Ú©Ø«Ø± ØªØ¹Ø¯Ø§Ø¯ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡

# ğŸ“‚ Ø§Ú¯Ø± ÙØ§ÛŒÙ„ Ø°Ø®ÛŒØ±Ù‡â€ŒÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªØŒ Ø§ÛŒØ¬Ø§Ø¯Ø´ Ú©Ù†
if not os.path.exists(MESSAGES_DB_LINKS):
    with open(MESSAGES_DB_LINKS, "w", encoding="utf-8") as file:
        json.dump({}, file, ensure_ascii=False, indent=4)

# ğŸ”‘ ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù… Ø§Ø² Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ Ø¨Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡
try:
    # Ø¯Ø±ÛŒØ§ÙØª ØªÙˆÚ©Ù† Ø§Ø² Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ
    TOKEN = os.environ.get('TELEGRAM_BOT_TOKEN')

    # Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¹ØªØ¨Ø§Ø± Ùˆ ÙØ±Ù…Øª ØªÙˆÚ©Ù†
    if not TOKEN:
        debug_log("âš ï¸ Ù…ØªØºÛŒØ± Ù…Ø­ÛŒØ·ÛŒ TELEGRAM_BOT_TOKEN ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª!", "ERROR")
        # Ø¨Ù‡ Ø¬Ø§ÛŒ Ø³Ø§Ø®Øª ØªÙˆÚ©Ù† Ø³Ø§Ø®ØªÚ¯ÛŒØŒ ÛŒÚ© Ø®Ø·Ø§ Ø±Ø§ Ø¨Ø§Ù„Ø§ Ù…ÛŒâ€ŒØ¢ÙˆØ±ÛŒÙ… ØªØ§ Ú©Ø¯ Ø¨Ù‡ ØµÙˆØ±Øª Ú©Ø§Ù…Ù„ Ù…ØªÙˆÙ‚Ù Ø´ÙˆØ¯
        raise ValueError("ØªÙˆÚ©Ù† ØªÙ„Ú¯Ø±Ø§Ù… ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª")

    # Ø¨Ø±Ø±Ø³ÛŒ ÙØ±Ù…Øª ØªÙˆÚ©Ù† (Ø¨Ø§ÛŒØ¯ Ø´Ø§Ù…Ù„ Ú©ÙˆÙ„ÙˆÙ† Ø¨Ø§Ø´Ø¯ Ùˆ Ø¨Ø®Ø´ Ø§ÙˆÙ„ Ø¢Ù† Ø¹Ø¯Ø¯ Ø¨Ø§Ø´Ø¯)
    if ":" not in TOKEN:
        debug_log(f"âš ï¸ ÙØ±Ù…Øª ØªÙˆÚ©Ù† Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª (Ø¨Ø§ÛŒØ¯ Ø´Ø§Ù…Ù„ Ú©ÙˆÙ„ÙˆÙ† (:) Ø¨Ø§Ø´Ø¯)", "ERROR")
        raise ValueError("ÙØ±Ù…Øª ØªÙˆÚ©Ù† ØªÙ„Ú¯Ø±Ø§Ù… Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª - Ú©ÙˆÙ„ÙˆÙ† ÛŒØ§ÙØª Ù†Ø´Ø¯")

    # ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ Ø¨Ø®Ø´ Ø§ÙˆÙ„ ØªÙˆÚ©Ù† Ø¨Ù‡ Ø¹Ø¯Ø¯ ØµØ­ÛŒØ­ (Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ØµØ­Øª ÙØ±Ù…Øª)
    try:
        int(TOKEN.split(':')[0])
    except ValueError:
        debug_log(f"âš ï¸ Ø¨Ø®Ø´ Ø§ÙˆÙ„ ØªÙˆÚ©Ù† Ø¨Ø§ÛŒØ¯ ÛŒÚ© Ø¹Ø¯Ø¯ ØµØ­ÛŒØ­ Ø¨Ø§Ø´Ø¯", "ERROR")
        raise ValueError("ÙØ±Ù…Øª ØªÙˆÚ©Ù† ØªÙ„Ú¯Ø±Ø§Ù… Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª - Ø¨Ø®Ø´ Ø§ÙˆÙ„ Ø¨Ø§ÛŒØ¯ Ø¹Ø¯Ø¯ Ø¨Ø§Ø´Ø¯")

    debug_log(f"ØªÙˆÚ©Ù† ØªÙ„Ú¯Ø±Ø§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø´Ø¯ (Ø·ÙˆÙ„: {len(TOKEN)})", "INFO")

    # Ø§ÛŒØ¬Ø§Ø¯ Ø¢Ø¨Ø¬Ú©Øª Ø±Ø¨Ø§Øª Ø¨Ø§ ØªÙˆÚ©Ù†
    bot = telebot.TeleBot(TOKEN)

except Exception as e:
    debug_log(f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ… ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª: {e}", "ERROR", {
        "error_type": type(e).__name__,
        "traceback": format_exception_with_context(e)
    })
    # Ø¨Ù‡ Ø¬Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø§ ØªÙˆÚ©Ù† Ù†Ø§Ù‚ØµØŒ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±Ø§ Ù…ØªÙˆÙ‚Ù Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ Ù…Ø´Ú©Ù„ Ø­Ù„ Ø´ÙˆØ¯
    print(f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø±Ø¨Ø§Øª. Ù„Ø·ÙØ§Ù‹ ØªÙˆÚ©Ù† Ù…Ø¹ØªØ¨Ø± Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯: {e}")
    # Ø§ÛŒØ¬Ø§Ø¯ Ù…ØªØºÛŒØ± BOT_INIT_ERROR Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¯Ø± Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±
    BOT_INIT_ERROR = str(e)

    # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² sys.exit() Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ Ø§Ø² Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯Ø± Ù…Ø­ÛŒØ· ØªÙˆÙ„ÛŒØ¯
    if os.environ.get('FLASK_ENV') == 'production':
        sys.exit(1)
    else:
        # Ø¯Ø± Ù…Ø­ÛŒØ· ØªÙˆØ³Ø¹Ù‡ØŒ Ø§Ø¬Ø§Ø²Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ… Ø§Ø¯Ø§Ù…Ù‡ ÛŒØ§Ø¨Ø¯ Ø§Ù…Ø§ Ø¨Ø¯ÙˆÙ† Ø§ÛŒØ¬Ø§Ø¯ Ø¢Ø¨Ø¬Ú©Øª Ø±Ø¨Ø§Øª
        print("âš ï¸ Ù…Ø­ÛŒØ· ØªÙˆØ³Ø¹Ù‡ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ø´Ø¯. Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯ÙˆÙ† Ø±Ø¨Ø§Øª ÙØ¹Ø§Ù„.")
        bot = None

# ğŸ“¢ Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ø§Ø¯Ù…ÛŒÙ†
ADMIN_CHAT_ID = 286420965

# ğŸ“Š ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙØ¶Ø§
MAX_VIDEOS_TO_KEEP = 0  # Ø­Ø¯Ø§Ú©Ø«Ø± ØªØ¹Ø¯Ø§Ø¯ ÙˆÛŒØ¯Ø¦Ùˆâ€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡ (ØµÙØ± = Ø­Ø°Ù ØªÙ…Ø§Ù… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ù¾Ø³ Ø§Ø² Ø§Ø±Ø³Ø§Ù„)
VIDEO_CACHE_TIMEOUT = 60 * 10  # Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ú©Ø´ ÙˆÛŒØ¯ÛŒÙˆ (10 Ø¯Ù‚ÛŒÙ‚Ù‡)

# ğŸ“‚ Ù…Ø³ÛŒØ± Ø°Ø®ÛŒØ±Ù‡ ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§
VIDEO_FOLDER = "videos"
INSTAGRAM_FOLDER = "instagram_videos"
os.makedirs(VIDEO_FOLDER, exist_ok=True)
os.makedirs(INSTAGRAM_FOLDER, exist_ok=True)

# ğŸ¬ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©ÛŒÙÛŒØª ÙˆÛŒØ¯ÛŒÙˆ
VIDEO_QUALITIES = {
    "144p": {"format": "160/17/18/597", "description": "Ú©ÛŒÙÛŒØª Ù¾Ø§ÛŒÛŒÙ† (144p) - Ø³Ø±ÛŒØ¹â€ŒØªØ±ÛŒÙ†"},
    "240p": {"format": "133+140/242+140/243+140/134+140/18", "description": "Ú©ÛŒÙÛŒØª Ù…Ø¹Ù…ÙˆÙ„ÛŒ (240p)"},
    "360p": {"format": "134+140/243+140/18/597/22", "description": "Ú©ÛŒÙÛŒØª Ù…ØªÙˆØ³Ø· (360p)"},
    "480p": {"format": "135+140/244+140/247+140/22", "description": "Ú©ÛŒÙÛŒØª Ø®ÙˆØ¨ (480p)"},
    "720p": {"format": "136+140/247+140/22", "description": "Ú©ÛŒÙÛŒØª Ø¹Ø§Ù„ÛŒ (720p) - Ø­Ø¬Ù… Ø¨Ø§Ù„Ø§"},
    "1080p": {"format": "137+140/248+140/22", "description": "Ú©ÛŒÙÛŒØª ÙÙˆÙ„ HD (1080p) - Ø­Ø¬Ù… Ø¨Ø³ÛŒØ§Ø± Ø¨Ø§Ù„Ø§"}
}

DEFAULT_VIDEO_QUALITY = "240p"  # Ú©ÛŒÙÛŒØª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¨Ø±Ø§ÛŒ ØµØ±ÙÙ‡â€ŒØ¬ÙˆÛŒÛŒ Ø¯Ø± ÙØ¶Ø§

# ğŸ”– ÙØ§ÛŒÙ„ Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§
HASHTAGS_FILE = "hashtags.json"

# Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù‡Ø´ØªÚ¯ 
hashtag_cache = {}

# Ø²Ù…Ø§Ù† Ø¢Ø®Ø±ÛŒÙ† Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
last_cleanup_time = 0

# ØªØ¹Ø¯Ø§Ø¯ Ø­Ø¯Ø§Ú©Ø«Ø± Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù‡Ø± Ú©Ø§Ù†Ø§Ù„
MAX_SEARCH_MESSAGES = 100000

# ØªØ¹Ø¯Ø§Ø¯ Ø­Ø¯Ø§Ú©Ø«Ø± Ù¾ÛŒØ§Ù… Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø± Ù‡Ø± Ù‡Ø´ØªÚ¯
MAX_SEND_MESSAGES = 100

# ØªØ§Ø¨Ø¹ Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§ Ùˆ Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ø§Ø² ÙØ§ÛŒÙ„
def load_hashtags():
    """Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§ Ùˆ Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ø§Ø² ÙØ§ÛŒÙ„"""
    try:
        if os.path.exists(HASHTAGS_FILE):
            with open(HASHTAGS_FILE, 'r', encoding='utf-8') as f:
                data = json.load(f)
                debug_log("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø´Ø¯", "INFO")
                return data
        else:
            data = {"hashtags": {}, "channels": []}
            with open(HASHTAGS_FILE, 'w', encoding='utf-8') as f:
                json.dump(data, f, ensure_ascii=False, indent=2)
            debug_log("ÙØ§ÛŒÙ„ Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯", "INFO")
            return data
    except Exception as e:
        debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§: {e}", "ERROR")
        return {"hashtags": {}, "channels": []}

# ØªØ§Ø¨Ø¹ Ø°Ø®ÛŒØ±Ù‡ Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§ Ùˆ Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ø¯Ø± ÙØ§ÛŒÙ„
def save_hashtags(data):
    """Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§ Ùˆ Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ø¯Ø± ÙØ§ÛŒÙ„"""
    try:
        with open(HASHTAGS_FILE, 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=2)
        debug_log("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯", "INFO")
        return True
    except Exception as e:
        debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§: {e}", "ERROR")
        return False

# ğŸ§¹ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ Ùˆ Ø­Ø°Ù ØªÙ…Ø§Ù… ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
def clear_folder(folder_path, max_files=MAX_VIDEOS_TO_KEEP):
    """Ø­Ø°Ù ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ Ùˆ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø­Ø¯Ø§Ú©Ø«Ø± ØªØ¹Ø¯Ø§Ø¯ Ù…Ø´Ø®ØµÛŒ ÙØ§ÛŒÙ„"""
    try:
        # Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ÙˆØ¬ÙˆØ¯ Ù¾ÙˆØ´Ù‡
        if not os.path.exists(folder_path):
            os.makedirs(folder_path)
            debug_log(f"Ù¾ÙˆØ´Ù‡ {folder_path} Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯", "INFO")
            return

        # Ø¨Ø±Ø±Ø³ÛŒ Ø¢ÛŒØ§ ÙÙˆÙ„Ø¯Ø± Ø§Ø³Øª ÛŒØ§ Ø®ÛŒØ±
        if not os.path.isdir(folder_path):
            debug_log(f"Ù…Ø³ÛŒØ± {folder_path} ÛŒÚ© Ù¾ÙˆØ´Ù‡ Ù†ÛŒØ³Øª", "ERROR")
            return

        try:
            # Ù„ÛŒØ³Øª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            files = []
            for item in os.listdir(folder_path):
                item_path = os.path.join(folder_path, item)
                # ÙÙ‚Ø· ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø±Ø§ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… (Ù†Ù‡ Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§)
                if os.path.isfile(item_path):
                    files.append(item)

            # Ø§Ú¯Ø± max_files ØµÙØ± Ø¨Ø§Ø´Ø¯ØŒ Ù‡Ù…Ù‡ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø±Ø§ Ø­Ø°Ù Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            if max_files == 0:
                files_to_delete = files
            # Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±ØªØŒ ÙÙ‚Ø· ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ Ø±Ø§ Ø­Ø°Ù Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            elif len(files) > max_files:
                # Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù† ØªØºÛŒÛŒØ± (Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±ÛŒÙ† Ø§ÙˆÙ„)
                try:
                    files = sorted(files, key=lambda x: os.path.getmtime(os.path.join(folder_path, x)))
                except Exception as sort_error:
                    debug_log("Ø®Ø·Ø§ Ø¯Ø± Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø²Ù…Ø§Ù†", "WARNING", {"error": str(sort_error)})
                    # Ø§Ú¯Ø± Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯ØŒ Ø¨Ù‡ ØµÙˆØ±Øª Ù…Ø¹Ù…ÙˆÙ„ÛŒ Ù…Ø±ØªØ¨ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                    files = sorted(files)

                # ØªØ¹Ø¯Ø§Ø¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ø¨Ø§ÛŒØ¯ Ø­Ø°Ù Ø´ÙˆÙ†Ø¯
                files_to_delete = files[:-max_files] if max_files > 0 else files
            else:
                # Ø§Ú¯Ø± ØªØ¹Ø¯Ø§Ø¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ú©Ù…ØªØ± Ø§Ø² Ø­Ø¯ Ù…Ø¬Ø§Ø² Ø§Ø³Øª Ùˆ max_files ØºÛŒØ±ØµÙØ± Ø§Ø³ØªØŒ Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ Ø­Ø°Ù Ù†ÛŒØ³Øª
                return

            debug_log(f"Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù¾ÙˆØ´Ù‡ {folder_path}", "INFO", {
                "total_files": len(files),
                "files_to_delete": len(files_to_delete),
                "max_files": max_files
            })

            # Ø­Ø°Ù ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ
            deleted_count = 0
            for old_file in files_to_delete:
                try:
                    file_path = os.path.join(folder_path, old_file)
                    os.remove(file_path)
                    deleted_count += 1
                except Exception as delete_error:
                    debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ÙØ§ÛŒÙ„ {old_file}", "WARNING", {"error": str(delete_error)})

            debug_log(f"Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù¾ÙˆØ´Ù‡ {folder_path} Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯", "INFO", {"deleted_files": deleted_count})
        except Exception as list_error:
            debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ù„ÛŒØ³Øª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù¾ÙˆØ´Ù‡", "ERROR", {"error": str(list_error)})

    except Exception as e:
        debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù¾ÙˆØ´Ù‡", "ERROR", {
            "folder": folder_path,
            "error": str(e),
            "traceback": traceback.format_exc()
        })


# ğŸ“Œ Ø¯Ø³ØªÙˆØ± Ø´Ø±ÙˆØ¹ - Start command
@bot.message_handler(commands=["start"])
def start_command(message):
    try:
        # Ø§ÛŒØ¬Ø§Ø¯ Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø§ÛŒÙ†Ù„Ø§ÛŒÙ† Ø¨Ø§ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
        markup = telebot.types.InlineKeyboardMarkup(row_width=2)
        help_btn = telebot.types.InlineKeyboardButton("ğŸ“š Ø±Ø§Ù‡Ù†Ù…Ø§", callback_data="download_help")
        quality_btn = telebot.types.InlineKeyboardButton("ğŸ“Š Ú©ÛŒÙÛŒØª ÙˆÛŒØ¯ÛŒÙˆ", callback_data="select_quality")
        status_btn = telebot.types.InlineKeyboardButton("ğŸ“ˆ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±", callback_data="server_status")

        markup.add(help_btn, quality_btn)
        markup.add(status_btn)

        # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø®ÙˆØ´Ø§Ù…Ø¯Ú¯ÙˆÛŒÛŒ
        bot.send_message(
            message.chat.id,
            f"ğŸ‘‹ Ø³Ù„Ø§Ù… {message.from_user.first_name}!\n\n"
            "ğŸ¬ Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.\n\n"
            "ğŸ”¸ <b>Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø±Ø¨Ø§Øª:</b>\n"
            "â€¢ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆ Ø§Ø² ÛŒÙˆØªÛŒÙˆØ¨ Ùˆ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…\n"
            "â€¢ Ø§Ù…Ú©Ø§Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ú©ÛŒÙÛŒØª ÙˆÛŒØ¯ÛŒÙˆ\n"
            "â€¢ Ù¾Ø§Ø³Ø®â€ŒÚ¯ÙˆÛŒÛŒ Ø¨Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„\n\n"
            "ğŸ”¹ <b>Ø±ÙˆØ´ Ø§Ø³ØªÙØ§Ø¯Ù‡:</b>\n"
            "Ú©Ø§ÙÛŒØ³Øª Ù„ÛŒÙ†Ú© ÙˆÛŒØ¯ÛŒÙˆÛŒ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø² ÛŒÙˆØªÛŒÙˆØ¨ ÛŒØ§ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.",
            parse_mode="HTML",
            reply_markup=markup
        )
    except Exception as e:
        notify_admin(f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø³ØªÙˆØ± start:\n{traceback.format_exc()}")
        bot.send_message(message.chat.id, "âš  Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")

# ğŸ“š Ø¯Ø³ØªÙˆØ± Ø±Ø§Ù‡Ù†Ù…Ø§ - Help command
@bot.message_handler(commands=["help"])
def help_command(message):
    try:
        # Ø§ÛŒØ¬Ø§Ø¯ Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø§ÛŒÙ†Ù„Ø§ÛŒÙ† Ø¨Ø§ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
        markup = telebot.types.InlineKeyboardMarkup(row_width=2)
        quality_btn = telebot.types.InlineKeyboardButton("ğŸ“Š Ø§Ù†ØªØ®Ø§Ø¨ Ú©ÛŒÙÛŒØª ÙˆÛŒØ¯ÛŒÙˆ", callback_data="select_quality")
        hashtag_btn = telebot.types.InlineKeyboardButton("ğŸ”– Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù‡Ø´ØªÚ¯", callback_data="hashtag_help")

        markup.add(quality_btn, hashtag_btn)

        # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø±Ø§Ù‡Ù†Ù…Ø§
        bot.send_message(
            message.chat.id,
            "ğŸ”° <b>Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±Ø¨Ø§Øª</b>\n\n"
            "ğŸ“Œ <b>Ø¯Ø³ØªÙˆØ±Ø§Øª Ø§ØµÙ„ÛŒ:</b>\n"
            "/start - Ø´Ø±ÙˆØ¹ Ú©Ø§Ø± Ø¨Ø§ Ø±Ø¨Ø§Øª\n"
            "/help - Ù†Ù…Ø§ÛŒØ´ Ø§ÛŒÙ† Ø±Ø§Ù‡Ù†Ù…Ø§\n"
            "/server_status - Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±\n\n"
            "ğŸ“¥ <b>Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆ:</b>\n"
            "â€¢ Ú©Ø§ÙÛŒØ³Øª Ù„ÛŒÙ†Ú© ÙˆÛŒØ¯ÛŒÙˆÛŒ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ø² ÛŒÙˆØªÛŒÙˆØ¨ ÛŒØ§ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯\n"
            "â€¢ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ú©ÛŒÙÛŒØª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ø² Ù…Ù†ÙˆÛŒ Ø²ÛŒØ± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯\n\n"
            "ğŸ”– <b>Ø¬Ø³ØªØ¬ÙˆÛŒ Ù‡Ø´ØªÚ¯:</b>\n"
            "â€¢ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§ Ø§Ø² Ø¯Ø³ØªÙˆØ±Ø§Øª /add_hashtagØŒ /remove_hashtag Ùˆ /hashtags Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯\n"
            "â€¢ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ø§Ø² Ø¯Ø³ØªÙˆØ±Ø§Øª /add_channelØŒ /remove_channel Ùˆ /channels Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯\n"
            "â€¢ Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù‡Ø´ØªÚ¯ Ø¯Ø± Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ø§Ø² Ø¯Ø³ØªÙˆØ± /search Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯\n\n"
            "âš ï¸ <b>Ù†Ú©Ø§Øª Ù…Ù‡Ù…:</b>\n"
            "â€¢ Ø¨Ø±Ø§ÛŒ ØµØ±ÙÙ‡â€ŒØ¬ÙˆÛŒÛŒ Ø¯Ø± Ø­Ø¬Ù… Ø§ÛŒÙ†ØªØ±Ù†Øª Ùˆ Ø³Ø±Ø¹Øª Ø¨Ø§Ù„Ø§ØªØ±ØŒ Ø§Ø² Ú©ÛŒÙÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯\n"
            "â€¢ Ú©ÛŒÙÛŒØª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ 240p Ø§Ø³Øª\n"
            "â€¢ ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ÛŒ Ø¨Ø§Ù„Ø§ÛŒ 50MB Ù‚Ø§Ø¨Ù„ Ø§Ø±Ø³Ø§Ù„ Ù†ÛŒØ³ØªÙ†Ø¯ Ùˆ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ú©ÛŒÙÛŒØª Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´ÙˆÙ†Ø¯",
            parse_mode="HTML",
            reply_markup=markup
        )
    except Exception as e:
        notify_admin(f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø³ØªÙˆØ± help:\n{traceback.format_exc()}")
        bot.send_message(message.chat.id, "âš  Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")

# ğŸ“Œ Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§ - Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù‡Ø´ØªÚ¯ Ø¬Ø¯ÛŒØ¯
@bot.message_handler(commands=["add_hashtag"])
def add_hashtag_command(message):
    try:
        # Ø¬Ø¯Ø§Ø³Ø§Ø²ÛŒ Ø¢Ø±Ú¯ÙˆÙ…Ø§Ù†â€ŒÙ‡Ø§
        args = message.text.split(maxsplit=2)

        # Ø¨Ø±Ø±Ø³ÛŒ Ø¢Ø±Ú¯ÙˆÙ…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù„Ø§Ø²Ù…
        if len(args) < 3:
            bot.reply_to(message, "âš ï¸ ÙØ±Ù…Øª Ø¯Ø³ØªÙˆØ± Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª.\n"
                        "ğŸ“ Ù†Ø­ÙˆÙ‡ Ø§Ø³ØªÙØ§Ø¯Ù‡: `/add_hashtag Ù†Ø§Ù…_Ù‡Ø´ØªÚ¯ ØªÙˆØ¶ÛŒØ­Ø§Øª`\n"
                        "Ù…Ø«Ø§Ù„: `/add_hashtag Ø¢Ù…ÙˆØ²Ø´ Ø§ÛŒÙ† Ù‡Ø´ØªÚ¯ Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø§Ø³Øª`", parse_mode="Markdown")
            return

        # Ø¯Ø±ÛŒØ§ÙØª Ù†Ø§Ù… Ù‡Ø´ØªÚ¯ Ùˆ ØªÙˆØ¶ÛŒØ­Ø§Øª
        hashtag = args[1]
        description = args[2]

        # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† # Ø¨Ù‡ Ø§Ø¨ØªØ¯Ø§ÛŒ Ù‡Ø´ØªÚ¯ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
        if not hashtag.startswith("#"):
            hashtag = "#" + hashtag

        # Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§
        data = load_hashtags()

        # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù‡Ø´ØªÚ¯ Ø¬Ø¯ÛŒØ¯
        data["hashtags"][hashtag] = {
            "description": description,
            "created_by": message.from_user.id,
            "created_at": time.strftime("%Y-%m-%d %H:%M:%S"),
            "messages": []
        }

        # Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§
        if save_hashtags(data):
            bot.reply_to(message, f"âœ… Ù‡Ø´ØªÚ¯ {hashtag} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.")
        else:
            bot.reply_to(message, "âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§.")

    except Exception as e:
        debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù‡Ø´ØªÚ¯", "ERROR", {"error": str(e)})
        bot.reply_to(message, "âš ï¸ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")

# ğŸ“Œ Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§ - Ø­Ø°Ù Ù‡Ø´ØªÚ¯
@bot.message_handler(commands=["remove_hashtag"])
def remove_hashtag_command(message):
    try:
        # Ø¬Ø¯Ø§Ø³Ø§Ø²ÛŒ Ø¢Ø±Ú¯ÙˆÙ…Ø§Ù†â€ŒÙ‡Ø§
        args = message.text.split(maxsplit=1)

        # Ø¨Ø±Ø±Ø³ÛŒ Ø¢Ø±Ú¯ÙˆÙ…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù„Ø§Ø²Ù…
        if len(args) < 2:
            bot.reply_to(message, "âš ï¸ ÙØ±Ù…Øª Ø¯Ø³ØªÙˆØ± Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª.\n"
                        "ğŸ“ Ù†Ø­ÙˆÙ‡ Ø§Ø³ØªÙØ§Ø¯Ù‡: `/remove_hashtag Ù†Ø§Ù…_Ù‡Ø´ØªÚ¯`\n"
                        "Ù…Ø«Ø§Ù„: `/remove_hashtag Ø¢Ù…ÙˆØ²Ø´`", parse_mode="Markdown")
            return

        # Ø¯Ø±ÛŒØ§ÙØª Ù†Ø§Ù… Ù‡Ø´ØªÚ¯
        hashtag = args[1]

        # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† # Ø¨Ù‡ Ø§Ø¨ØªØ¯Ø§ÛŒ Ù‡Ø´ØªÚ¯ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
        if not hashtag.startswith("#"):
            hashtag = "#" + hashtag

        # Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§
        data = load_hashtags()

        # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ù‡Ø´ØªÚ¯
        if hashtag not in data["hashtags"]:
            bot.reply_to(message, f"âš ï¸ Ù‡Ø´ØªÚ¯ {hashtag} ÛŒØ§ÙØª Ù†Ø´Ø¯.")
            return

        # Ø­Ø°Ù Ù‡Ø´ØªÚ¯
        del data["hashtags"][hashtag]

        # Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§
        if save_hashtags(data):
            bot.reply_to(message, f"âœ… Ù‡Ø´ØªÚ¯ {hashtag} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.")
        else:
            bot.reply_to(message, "âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§.")

    except Exception as e:
        debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù‡Ø´ØªÚ¯", "ERROR", {"error": str(e)})
        bot.reply_to(message, "âš ï¸ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")

# ğŸ“Œ Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§ - Ù„ÛŒØ³Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§
@bot.message_handler(commands=["hashtags"])
def list_hashtags_command(message):
    try:
        # Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§
        data = load_hashtags()

        # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ù‡Ø´ØªÚ¯
        if not data["hashtags"]:
            bot.reply_to(message, "âš ï¸ Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ù‡Ø´ØªÚ¯ÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.")
            return

        # Ø³Ø§Ø®Øª Ù¾ÛŒØ§Ù… Ù„ÛŒØ³Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§
        hashtags_list = ["ğŸ”– <b>Ù„ÛŒØ³Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§ÛŒ ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡:</b>\n"]

        for idx, (hashtag, info) in enumerate(data["hashtags"].items(), 1):
            hashtags_list.append(f"{idx}. <code>{hashtag}</code> - {info['description']}")

        # Ø§Ø±Ø³Ø§Ù„ Ù„ÛŒØ³Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§
        bot.reply_to(message, "\n".join(hashtags_list), parse_mode="HTML")

    except Exception as e:
        debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§", "ERROR", {"error": str(e)})
        bot.reply_to(message, "âš ï¸ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")

# ğŸ“Œ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ - Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ø§Ù†Ø§Ù„
@bot.message_handler(commands=["add_channel"])
def add_channel_command(message):
    try:
        # Ø¬Ø¯Ø§Ø³Ø§Ø²ÛŒ Ø¢Ø±Ú¯ÙˆÙ…Ø§Ù†â€ŒÙ‡Ø§
        args = message.text.split(maxsplit=1)

        # Ø¨Ø±Ø±Ø³ÛŒ Ø¢Ø±Ú¯ÙˆÙ…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù„Ø§Ø²Ù…
        if len(args) < 2:
            bot.reply_to(message, "âš ï¸ ÙØ±Ù…Øª Ø¯Ø³ØªÙˆØ± Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª.\n"
                        "ğŸ“ Ù†Ø­ÙˆÙ‡ Ø§Ø³ØªÙØ§Ø¯Ù‡: `/add_channel Ø¢ÛŒØ¯ÛŒ_Ú©Ø§Ù†Ø§Ù„`\n"
                        "Ù…Ø«Ø§Ù„: `/add_channel @mychannel` ÛŒØ§ `/add_channel -1001234567890`", parse_mode="Markdown")
            return

        # Ø¯Ø±ÛŒØ§ÙØª Ø¢ÛŒØ¯ÛŒ Ú©Ø§Ù†Ø§Ù„
        channel_id = args[1]

        # Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§
        data = load_hashtags()

        # Ø¨Ø±Ø±Ø³ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ Ù†Ø¨ÙˆØ¯Ù† Ú©Ø§Ù†Ø§Ù„
        if channel_id in data["channels"]:
            bot.reply_to(message, f"âš ï¸ Ú©Ø§Ù†Ø§Ù„ {channel_id} Ù‚Ø¨Ù„Ø§Ù‹ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª.")
            return

        # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ø§Ù†Ø§Ù„ Ø¬Ø¯ÛŒØ¯
        data["channels"].append(channel_id)

        # Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§
        if save_hashtags(data):
            bot.reply_to(message, f"âœ… Ú©Ø§Ù†Ø§Ù„ {channel_id} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.")
        else:
            bot.reply_to(message, "âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§.")

    except Exception as e:
        debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ú©Ø§Ù†Ø§Ù„", "ERROR", {"error": str(e)})
        bot.reply_to(message, "âš ï¸ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")

# ğŸ“Œ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ - Ø­Ø°Ù Ú©Ø§Ù†Ø§Ù„
@bot.message_handler(commands=["remove_channel"])
def remove_channel_command(message):
    try:
        # Ø¬Ø¯Ø§Ø³Ø§Ø²ÛŒ Ø¢Ø±Ú¯ÙˆÙ…Ø§Ù†â€ŒÙ‡Ø§
        args = message.text.split(maxsplit=1)

        # Ø¨Ø±Ø±Ø³ÛŒ Ø¢Ø±Ú¯ÙˆÙ…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù„Ø§Ø²Ù…
        if len(args) < 2:
            bot.reply_to(message, "âš ï¸ ÙØ±Ù…Øª Ø¯Ø³ØªÙˆØ± Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª.\n"
                        "ğŸ“ Ù†Ø­ÙˆÙ‡ Ø§Ø³ØªÙØ§Ø¯Ù‡: `/remove_channel Ø¢ÛŒØ¯ÛŒ_Ú©Ø§Ù†Ø§Ù„`\n"
                        "Ù…Ø«Ø§Ù„: `/remove_channel @mychannel` ÛŒØ§ `/remove_channel -1001234567890`", parse_mode="Markdown")
            return

        # Ø¯Ø±ÛŒØ§ÙØª Ø¢ÛŒØ¯ÛŒ Ú©Ø§Ù†Ø§Ù„
        channel_id = args[1]

        # Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§
        data = load_hashtags()

        # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ú©Ø§Ù†Ø§Ù„
        if channel_id not in data["channels"]:
            bot.reply_to(message, f"âš ï¸ Ú©Ø§Ù†Ø§Ù„ {channel_id} ÛŒØ§ÙØª Ù†Ø´Ø¯.")
            return

        # Ø­Ø°Ù Ú©Ø§Ù†Ø§Ù„
        data["channels"].remove(channel_id)

        # Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§
        if save_hashtags(data):
            bot.reply_to(message, f"âœ… Ú©Ø§Ù†Ø§Ù„ {channel_id} Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.")
        else:
            bot.reply_to(message, "âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§.")

    except Exception as e:
        debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú©Ø§Ù†Ø§Ù„", "ERROR", {"error": str(e)})
        bot.reply_to(message, "âš ï¸ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")

# ğŸ“Œ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ - Ù„ÛŒØ³Øª Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§
@bot.message_handler(commands=["channels"])
def list_channels_command(message):
    try:
        # Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§
        data = load_hashtags()

        # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ú©Ø§Ù†Ø§Ù„
        if not data["channels"]:
            bot.reply_to(message, "âš ï¸ Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ú©Ø§Ù†Ø§Ù„ÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.")
            return

        # Ø³Ø§Ø®Øª Ù¾ÛŒØ§Ù… Ù„ÛŒØ³Øª Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§
        channels_list = ["ğŸ“¢ <b>Ù„ÛŒØ³Øª Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡:</b>\n"]

        for idx, channel_id in enumerate(data["channels"], 1):
            channels_list.append(f"{idx}. <code>{channel_id}</code>")

        # Ø§Ø±Ø³Ø§Ù„ Ù„ÛŒØ³Øª Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§
        bot.reply_to(message, "\n".join(channels_list), parse_mode="HTML")

    except Exception as e:
        debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§", "ERROR", {"error": str(e)})
        bot.reply_to(message, "âš ï¸ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")

# ğŸ“Œ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù‡Ø´ØªÚ¯ - Ø¯Ø³ØªÙˆØ± Ø¬Ø³ØªØ¬ÙˆÛŒ Ù‡Ø´ØªÚ¯
@bot.message_handler(commands=["search"])
def search_hashtag_command(message):
    try:
        # Ø¬Ø¯Ø§Ø³Ø§Ø²ÛŒ Ø¢Ø±Ú¯ÙˆÙ…Ø§Ù†â€ŒÙ‡Ø§
        args = message.text.split(maxsplit=1)

        # Ø¨Ø±Ø±Ø³ÛŒ Ø¢Ø±Ú¯ÙˆÙ…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù„Ø§Ø²Ù…
        if len(args) < 2:
            bot.reply_to(message, "âš ï¸ ÙØ±Ù…Øª Ø¯Ø³ØªÙˆØ± Ù†Ø§Ø¯Ø±Ø³Øª Ø§Ø³Øª.\n"
                        "ğŸ“ Ù†Ø­ÙˆÙ‡ Ø§Ø³ØªÙØ§Ø¯Ù‡: `/search Ù†Ø§Ù…_Ù‡Ø´ØªÚ¯`\n"
                        "Ù…Ø«Ø§Ù„: `/search Ø¢Ù…ÙˆØ²Ø´`", parse_mode="Markdown")
            return

        # Ø¯Ø±ÛŒØ§ÙØª Ù†Ø§Ù… Ù‡Ø´ØªÚ¯
        hashtag = args[1]

        # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† # Ø¨Ù‡ Ø§Ø¨ØªØ¯Ø§ÛŒ Ù‡Ø´ØªÚ¯ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
        if not hashtag.startswith("#"):
            hashtag = "#" + hashtag

        # Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§
        data = load_hashtags()

        # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ù‡Ø´ØªÚ¯
        if hashtag not in data["hashtags"]:
            bot.reply_to(message, f"âš ï¸ Ù‡Ø´ØªÚ¯ {hashtag} ÛŒØ§ÙØª Ù†Ø´Ø¯.")
            return

        # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù‡Ø´ØªÚ¯
        hashtag_data = data["hashtags"][hashtag]
        if not hashtag_data["messages"]:
            processing_msg = bot.reply_to(message, f"ğŸ” Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ù‡Ø´ØªÚ¯ {hashtag}...")

            # Ø§ÛŒØ¬Ø§Ø¯ ØªØ±Ø¯ Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù‡Ø´ØªÚ¯ Ø¯Ø± Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§
            search_thread = threading.Thread(
                target=search_hashtag_in_channels,
                args=(message, hashtag, processing_msg.message_id)
            )
            search_thread.daemon = True
            search_thread.start()
        else:
            # Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù‡Ø´ØªÚ¯
            show_hashtag_messages(message, hashtag, data["hashtags"][hashtag]["messages"])

    except Exception as e:
        debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬ÙˆÛŒ Ù‡Ø´ØªÚ¯", "ERROR", {"error": str(e)})
        bot.reply_to(message, "âš ï¸ Ø®Ø·Ø§ÛŒÛŒ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")

# ğŸ“Œ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù‡Ø´ØªÚ¯ Ø¯Ø± Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§
def search_hashtag_in_channels(message, hashtag, processing_msg_id):
    try:
        # Ø¨Ø§Ø±Ú¯ÛŒØ±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§
        data = load_hashtags()

        # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ú©Ø§Ù†Ø§Ù„
        if not data["channels"]:
            bot.edit_message_text(
                "âš ï¸ Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ú©Ø§Ù†Ø§Ù„ÛŒ ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.",
                chat_id=message.chat.id,
                message_id=processing_msg_id
            )
            return

        found_messages = []
        total_channels = len(data["channels"])
        processed_channels = 0

        # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾ÛŒØ§Ù… Ù¾Ø±Ø¯Ø§Ø²Ø´
        bot.edit_message_text(
            f"ğŸ” Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬ÙˆÛŒ {total_channels} Ú©Ø§Ù†Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ù‡Ø´ØªÚ¯ {hashtag}...\n"
            f"Ù¾ÛŒØ´Ø±ÙØª: 0/{total_channels} Ú©Ø§Ù†Ø§Ù„",
            chat_id=message.chat.id,
            message_id=processing_msg_id
        )

        # Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù‡Ø± Ú©Ø§Ù†Ø§Ù„
        for channel_id in data["channels"]:
            try:
                # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù¾ÛŒØ§Ù… Ù¾Ø±Ø¯Ø§Ø²Ø´
                processed_channels += 1
                bot.edit_message_text(
                    f"ğŸ” Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬ÙˆÛŒ {total_channels} Ú©Ø§Ù†Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ù‡Ø´ØªÚ¯ {hashtag}...\n"
                    f"Ù¾ÛŒØ´Ø±ÙØª: {processed_channels}/{total_channels} Ú©Ø§Ù†Ø§Ù„",
                    chat_id=message.chat.id,
                    message_id=processing_msg_id
                )

                # Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù†Ø§Ù„
                messages = []

                try:
                    # ØªØ¨Ø¯ÛŒÙ„ channel_id Ø¨Ù‡ Ø¹Ø¯Ø¯ Ø§Ú¯Ø± Ù…Ù…Ú©Ù† Ø¨Ø§Ø´Ø¯ (Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ)
                    numeric_channel_id = None
                    if isinstance(channel_id, str):
                        if channel_id.startswith('-100') and channel_id[4:].isdigit():
                            numeric_channel_id = int(channel_id)
                        elif channel_id.lstrip('-').isdigit():
                            numeric_channel_id = int(channel_id)

                    # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² channel_links.json Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
                    channel_data = {}
                    if os.path.exists('channel_links.json'):
                        with open('channel_links.json', 'r', encoding='utf-8') as f:
                            channel_data = json.load(f)

                    # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù†Ø§Ù„ Ø¯Ø± ÙØ§ÛŒÙ„
                    channel_key = str(numeric_channel_id) if numeric_channel_id else channel_id
                    if channel_key in channel_data:
                        debug_log(f"Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù†Ø§Ù„ {channel_id} Ø§Ø² ÙØ§ÛŒÙ„ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯", "INFO")

                        # ØªØ¨Ø¯ÛŒÙ„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù†Ø§Ù„ Ø¨Ù‡ ÙØ±Ù…Øª Ù…Ù†Ø§Ø³Ø¨
                        for msg_data in channel_data[channel_key]:
                            # Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² ÙˆØ¬ÙˆØ¯ ÙÛŒÙ„Ø¯ text
                            if 'text' not in msg_data:
                                continue

                            messages.append(types.SimpleNamespace(
                                chat_id=msg_data.get('chat_id'),
                                message_id=msg_data.get('message_id'),
                                text=msg_data.get('text', ''),
                                date=datetime.datetime.strptime(
                                    msg_data.get('date', '2025-01-01 00:00:00'), 
                                    '%Y-%m-%d %H:%M:%S'
                                )
                            ))
                    else:
                        debug_log(f"Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù†Ø§Ù„ {channel_id} Ø¯Ø± ÙØ§ÛŒÙ„ ÛŒØ§ÙØª Ù†Ø´Ø¯", "INFO")

                except Exception as get_history_error:
                    debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú©Ø§Ù†Ø§Ù„: {str(get_history_error)}", "WARNING")

                # Ø¨Ø±Ø±Ø³ÛŒ Ù‡Ø´ØªÚ¯ Ø¯Ø± Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
                for msg in messages:
                    if hashtag.lower() in msg.text.lower():
                        found_messages.append({
                            "chat_id": channel_id,
                            "message_id": msg.message_id,
                            "text": msg.text[:100] + "..." if len(msg.text) > 100 else msg.text,
                            "date": msg.date.strftime("%Y-%m-%d %H:%M:%S") if hasattr(msg, "date") else "Ù†Ø§Ù…Ø´Ø®Øµ"
                        })

                # Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† ØªØ¹Ø¯Ø§Ø¯ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ ÛŒØ§ÙØª Ø´Ø¯Ù‡
                if len(found_messages) >= MAX_SEND_MESSAGES:
                    break

            except Exception as channel_error:
                debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ù†Ø§Ù„ {channel_id}", "WARNING", {"error": str(channel_error)})
                continue

        # Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ ÛŒØ§ÙØª Ø´Ø¯Ù‡ Ø¯Ø± Ù‡Ø´ØªÚ¯
        data["hashtags"][hashtag]["messages"] = found_messages
        save_hashtags(data)

        # Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ ÛŒØ§ÙØª Ø´Ø¯Ù‡
        if found_messages:
            bot.edit_message_text(
                f"âœ… Ø¬Ø³ØªØ¬Ùˆ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯. {len(found_messages)} Ù¾ÛŒØ§Ù… ÛŒØ§ÙØª Ø´Ø¯.",
                chat_id=message.chat.id,
                message_id=processing_msg_id
            )
            time.sleep(1)  # ØªØ£Ø®ÛŒØ± Ú©ÙˆØªØ§Ù‡
            show_hashtag_messages(message, hashtag, found_messages)
        else:
            bot.edit_message_text(
                f"âš ï¸ Ù‡ÛŒÚ† Ù¾ÛŒØ§Ù…ÛŒ Ø¨Ø§ Ù‡Ø´ØªÚ¯ {hashtag} ÛŒØ§ÙØª Ù†Ø´Ø¯.",
                chat_id=message.chat.id,
                message_id=processing_msg_id
            )

    except Exception as e:
        debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬ÙˆÛŒ Ù‡Ø´ØªÚ¯ Ø¯Ø± Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§", "ERROR", {"error": str(e)})
        try:
            bot.edit_message_text(
                "âš ï¸ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.",
                chat_id=message.chat.id,
                message_id=processing_msg_id
            )
        except:
            pass

# ğŸ“Œ Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù‡Ø´ØªÚ¯
def show_hashtag_messages(message, hashtag, messages):
    try:
        if not messages:
            bot.reply_to(message, f"âš ï¸ Ù‡ÛŒÚ† Ù¾ÛŒØ§Ù…ÛŒ Ø¨Ø±Ø§ÛŒ Ù‡Ø´ØªÚ¯ {hashtag} ÛŒØ§ÙØª Ù†Ø´Ø¯.")
            return

        # Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† ØªØ¹Ø¯Ø§Ø¯ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
        if len(messages) > MAX_SEND_MESSAGES:
            messages = messages[:MAX_SEND_MESSAGES]

        # Ø³Ø§Ø®Øª Ù¾ÛŒØ§Ù… Ù†ØªØ§ÛŒØ¬
        results = [f"ğŸ”– <b>Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ Ù‡Ø´ØªÚ¯ {hashtag}:</b>\n"]

        for idx, msg in enumerate(messages, 1):
            chat_id = msg.get("chat_id", "Ù†Ø§Ù…Ø´Ø®Øµ")
            message_id = msg.get("message_id", "Ù†Ø§Ù…Ø´Ø®Øµ")
            text = msg.get("text", "")
            date = msg.get("date", "Ù†Ø§Ù…Ø´Ø®Øµ")

            results.append(f"{idx}. <b>{date}</b>\n{text}\n")

        # Ø§Ø±Ø³Ø§Ù„ Ù†ØªØ§ÛŒØ¬
        bot.reply_to(message, "\n".join(results), parse_mode="HTML")

    except Exception as e:
        debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù‡Ø´ØªÚ¯", "ERROR", {"error": str(e)})
        bot.reply_to(message, "âš ï¸ Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ù†ØªØ§ÛŒØ¬ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")
        #Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±
@bot.message_handler(commands=["server_status"])
def server_status(message):
    try:
        # Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø´ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±
        cached_status = get_cached_server_status()
        if cached_status:
            bot.send_message(message.chat.id, cached_status, parse_mode="Markdown")
            return

        # Ø´Ø±ÙˆØ¹ Ø³Ø§Ø®Øª Ù¾ÛŒØ§Ù… ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ…
        status_sections = []
        status_sections.append("ğŸ“Š **ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±:**\n")

        # Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÛŒØ³ØªÙ…â€ŒØ¹Ø§Ù…Ù„ Ùˆ Ù†Ø³Ø®Ù‡ Ù¾Ø§ÛŒØªÙˆÙ†
        try:
            os_info = platform.platform()
            python_version = platform.python_version()
            status_sections.append(f"ğŸ”¹ **Ø³ÛŒØ³ØªÙ… Ø¹Ø§Ù…Ù„:** `{os_info}`\n")
            status_sections.append(f"ğŸ”¹ **Ù¾Ø§ÛŒØªÙˆÙ†:** `{python_version}`\n")
        except Exception as sys_error:
            status_sections.append("ğŸ”¹ **Ø³ÛŒØ³ØªÙ… Ø¹Ø§Ù…Ù„:** `Ù†Ø§Ù…Ø´Ø®Øµ`\n")
            status_sections.append("ğŸ”¹ **Ù¾Ø§ÛŒØªÙˆÙ†:** `Ù†Ø§Ù…Ø´Ø®Øµ`\n")
            print(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÛŒØ³ØªÙ…: {sys_error}")

        # Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª CPU Ø¨Ø§ Ø¬Ø²Ø¦ÛŒØ§Øª
        if 'psutil' in globals():
            try:
                cpu_percentages = psutil.cpu_percent(interval=1, percpu=True)
                cpu_avg = sum(cpu_percentages) / len(cpu_percentages)
                core_count = psutil.cpu_count(logical=True)
                status_sections.append(f"ğŸ”¹ **CPU:** {cpu_avg:.2f}% (ØªØ¹Ø¯Ø§Ø¯ Ù‡Ø³ØªÙ‡â€ŒÙ‡Ø§: {core_count})\n")
            except Exception as cpu_error:
                status_sections.append("ğŸ”¹ **CPU:** `Ù†Ø§Ù…Ø´Ø®Øµ`\n")
                print(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª CPU: {cpu_error}")

        # Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒØ²Ø§Ù† Ù…ØµØ±Ù Ø±Ù…
        try:
            ram = psutil.virtual_memory()
            ram_used = ram.used / (1024**3)
            ram_total = ram.total / (1024**3)
            ram_percent = (ram.used / ram.total) * 100
            status_sections.append(f"ğŸ”¹ **RAM:** {ram_used:.2f}GB / {ram_total:.2f}GB ({ram_percent:.1f}%)\n")
        except Exception as ram_error:
            status_sections.append("ğŸ”¹ **RAM:** `Ù†Ø§Ù…Ø´Ø®Øµ`\n")
            print(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª RAM: {ram_error}")

        # Ø¨Ø±Ø±Ø³ÛŒ Ùˆ Ù†Ù…Ø§ÛŒØ´ ÙØ¶Ø§ÛŒ Ø¯ÛŒØ³Ú©
        if 'shutil' in globals():
            try:
                total, used, free = shutil.disk_usage("/")
                used_gb = used / (1024**3)
                total_gb = total / (1024**3)
                free_gb = free / (1024**3)
                disk_percent = (used / total) * 100
                status_sections.append(f"ğŸ”¹ **ÙØ¶Ø§ÛŒ Ø¯ÛŒØ³Ú©:** {used_gb:.2f}GB / {total_gb:.2f}GB ({disk_percent:.1f}%)\n")
            except Exception as disk_error:
                status_sections.append("ğŸ”¹ **ÙØ¶Ø§ÛŒ Ø¯ÛŒØ³Ú©:** `Ù†Ø§Ù…Ø´Ø®Øµ`\n")
                print(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÛŒØ³Ú©: {disk_error}")

        # Ù†Ù…Ø§ÛŒØ´ Ø²Ù…Ø§Ù† Ø³Ø±ÙˆØ±
        try:
            current_time = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            status_sections.append(f"ğŸ”¹ **Ø²Ù…Ø§Ù† Ø³Ø±ÙˆØ±:** `{current_time}`\n")
        except Exception as time_error:
            status_sections.append("ğŸ”¹ **Ø²Ù…Ø§Ù† Ø³Ø±ÙˆØ±:** `Ù†Ø§Ù…Ø´Ø®Øµ`\n")
            print(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø²Ù…Ø§Ù†: {time_error}")

        # ØªØ±Ú©ÛŒØ¨ Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ§Ù…
        status_msg = "".join(status_sections)

        # Ø°Ø®ÛŒØ±Ù‡ Ú©Ø´ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù‡Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§
        try:
            with open("server_status.json", "w", encoding="utf-8") as file:
                json.dump({"timestamp": current_time, "status": status_msg}, file)
        except Exception as cache_write_error:
            print(f"Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ú©Ø´ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±: {cache_write_error}")

        # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
        bot.send_message(message.chat.id, status_msg, parse_mode="Markdown")

    except Exception as e:
        error_message = f"âš  Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±: {str(e)}"
        bot.send_message(message.chat.id, error_message)
        notify_admin(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÙˆØ± server_status: {str(e)}\n{traceback.format_exc()}")

        # ØªØ±Ú©ÛŒØ¨ Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ§Ù…
        status_msg = "".join(status_sections)

        # Ø°Ø®ÛŒØ±Ù‡ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ± Ø¯Ø± ÛŒÚ© ÙØ§ÛŒÙ„ JSON Ø¨Ø±Ø§ÛŒ Ú©Ø´ Ú©Ø±Ø¯Ù†
        try:
            with open("server_status.json", "w", encoding="utf-8") as file:
                json.dump(
                    {
                        "timestamp": datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                        "status": status_msg
                    }, file)
        except Exception as cache_write_error:
            print(f"Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ú©Ø´ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±: {cache_write_error}")

        # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
        bot.send_message(message.chat.id, status_msg, parse_mode="Markdown")

    except Exception as e:
        error_message = f"âš  Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±: {str(e)}"
        bot.send_message(message.chat.id, error_message)
        notify_admin(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø³ØªÙˆØ± server_status: {str(e)}\n{traceback.format_exc()}")


# ğŸ“‚ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ù…ØªÙ†ÛŒ
def load_responses():
    try:
        with open("responses.json", "r", encoding="utf-8") as file:
            return json.load(file)
    except FileNotFoundError:
        return {}


def save_responses():
    with open("responses.json", "w", encoding="utf-8") as file:
        json.dump(responses, file, ensure_ascii=False, indent=4)


responses = load_responses()


# ğŸ“Œ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ù†Ù„ÙˆØ¯
# Ú©Ø´ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¬Ø¯Ø¯
video_url_cache = {}

def get_direct_video_url(link):
    try:
        # Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¹ØªØ¨Ø± Ø¨ÙˆØ¯Ù† Ù„ÛŒÙ†Ú©
        if not link or not isinstance(link, str):
            debug_log("Ù„ÛŒÙ†Ú© Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¯Ø± get_direct_video_url", "WARNING", {"link": str(link)})
            return None

        # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ù„ÛŒÙ†Ú© Ø¯Ø± Ú©Ø´
        current_time = time.time()
        if link in video_url_cache:
            cache_data = video_url_cache[link]
            # Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¹ØªØ¨Ø§Ø± Ú©Ø´ (6 Ø³Ø§Ø¹Øª)
            if current_time - cache_data['timestamp'] < VIDEO_CACHE_TIMEOUT:
                debug_log(f"Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… Ø§Ø² Ú©Ø´ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¯: {link}", "INFO")
                return cache_data['direct_url']
            else:
                # Ø­Ø°Ù Ú©Ø´ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡
                del video_url_cache[link]

        # Ø¨Ø±Ø±Ø³ÛŒ YoutubeDL
        if 'YoutubeDL' not in globals():
            debug_log("YoutubeDL Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª", "ERROR")
            return None

        ydl_opts = {
            'quiet': True,
            'skip_download': True,
            'noplaylist': True,
            'force_generic_extractor': False,
            'format': 'best[ext=mp4]/best',
            'socket_timeout': 10,  # Ú©Ø§Ù‡Ø´ Ø²Ù…Ø§Ù† Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„
            'retries': 2,         # Ú©Ø§Ù‡Ø´ ØªØ¹Ø¯Ø§Ø¯ ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø¬Ø¯Ø¯
        }

        debug_log(f"ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… Ø§Ø² {link}", "INFO")

        with YoutubeDL(ydl_opts) as ydl:
            try:
                # ØªÙ†Ø¸ÛŒÙ… Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ø²Ù…Ø§Ù†ÛŒ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
                info = ydl.extract_info(link, download=False)

                if not info:
                    debug_log("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¯Ù‡ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª", "WARNING")
                    return None

                direct_url = info.get('url', None)

                # Ø°Ø®ÛŒØ±Ù‡ Ù„ÛŒÙ†Ú© Ø¯Ø± Ú©Ø´
                if direct_url:
                    video_url_cache[link] = {
                        'direct_url': direct_url,
                        'timestamp': current_time
                    }
                    # Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø§Ù†Ø¯Ø§Ø²Ù‡ Ú©Ø´ Ø¨Ù‡ Ø­Ø¯Ø§Ú©Ø«Ø± 50 Ù…ÙˆØ±Ø¯
                    if len(video_url_cache) > 50:
                        # Ø­Ø°Ù Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±ÛŒÙ† Ù…ÙˆØ±Ø¯ Ú©Ø´
                        oldest_link = min(video_url_cache.items(), key=lambda x: x[1]['timestamp'])[0]
                        del video_url_cache[oldest_link]

                if direct_url:
                    debug_log("Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¯", "INFO")
                    return direct_url
                else:
                    debug_log("Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… Ø¯Ø± Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¯Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯", "WARNING")
                    return None

            except Exception as extract_error:
                debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø² Ù„ÛŒÙ†Ú©", "ERROR", {
                    "error": str(extract_error),
                    "traceback": traceback.format_exc()
                })
                return None

    except Exception as e:
        debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… ÙˆÛŒØ¯ÛŒÙˆ", "ERROR", {
            "error": str(e),
            "traceback": traceback.format_exc()
        })

        try:
            # ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†
            notify_admin(f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… ÙˆÛŒØ¯ÛŒÙˆ:\n{traceback.format_exc()}")
        except Exception as notify_error:
            debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø·Ù„Ø§Ø¹ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†", "ERROR", {"error": str(notify_error)})

        return None


# ğŸ“Œ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆ Ø§Ø² Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…
def download_instagram(link):
    try:
        # Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¹ØªØ¨Ø± Ø¨ÙˆØ¯Ù† Ù„ÛŒÙ†Ú©
        if not link or not isinstance(link, str):
            debug_log("Ù„ÛŒÙ†Ú© Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¯Ø± download_instagram", "WARNING", {"link": str(link)})
            return None

        # Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… Ø¯Ø± Ù„ÛŒÙ†Ú©
        if "instagram.com" not in link:
            debug_log("Ù„ÛŒÙ†Ú© Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… Ù†ÛŒØ³Øª", "WARNING", {"link": link})
            return None

        # Ø¨Ø±Ø±Ø³ÛŒ YoutubeDL
        if 'YoutubeDL' not in globals():
            debug_log("YoutubeDL Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª", "ERROR")
            return None

        # Ø¨Ø±Ø±Ø³ÛŒ Ø§Ù…Ú©Ø§Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… (Ø³Ø±ÛŒØ¹â€ŒØªØ±)
        direct_url = get_direct_video_url(link)
        if direct_url:
            debug_log(f"Ø§Ø² Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ¯ÛŒÙˆÛŒ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯", "INFO")
            return direct_url

        # Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ
        try:
            clear_folder(INSTAGRAM_FOLDER)
        except Exception as clear_error:
            debug_log("Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù¾ÙˆØ´Ù‡ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…", "WARNING", {"error": str(clear_error)})
            # Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ… Ø­ØªÛŒ Ø§Ú¯Ø± Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´ÙˆØ¯

        debug_log(f"Ø´Ø±ÙˆØ¹ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ø² Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…: {link}", "INFO")

        ydl_opts = {
            'outtmpl': f'{INSTAGRAM_FOLDER}/%(id)s.%(ext)s',
            'format': 'mp4/best',
            'quiet': True,  # Ø³Ø§Ú©Øªâ€ŒØªØ± Ø¨Ø±Ø§ÛŒ Ø³Ø±Ø¹Øª Ø¨ÛŒØ´ØªØ±
            'noplaylist': True,
            'socket_timeout': 10,  # Ú©Ø§Ù‡Ø´ Ø²Ù…Ø§Ù† Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„
            'retries': 2,         # Ú©Ø§Ù‡Ø´ ØªØ¹Ø¯Ø§Ø¯ ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø¬Ø¯Ø¯
        }

        with YoutubeDL(ydl_opts) as ydl:
            try:
                info = ydl.extract_info(link, download=True)

                if not info:
                    debug_log("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª", "WARNING")
                    return None

                if not info.get('id'):
                    debug_log("Ø´Ù†Ø§Ø³Ù‡ ÙˆÛŒØ¯ÛŒÙˆ Ø¯Ø± Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø§Ù†Ù„ÙˆØ¯ ÛŒØ§ÙØª Ù†Ø´Ø¯", "WARNING", {"info": str(info)[:500]})
                    return None

                # Ú†Ú© Ú©Ø±Ø¯Ù† Ú†Ù†Ø¯ÛŒÙ† ÙØ±Ù…Øª ÙØ§ÛŒÙ„
                possible_extensions = ['mp4', 'webm', 'mkv', 'mov', 'avi']
                for ext in possible_extensions:
                    video_path = f"{INSTAGRAM_FOLDER}/{info['id']}.{ext}"
                    if os.path.exists(video_path):
                        debug_log(f"ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯: {video_path}", "INFO", {
                            "file_size": os.path.getsize(video_path) / (1024 * 1024),
                            "format": ext
                        })
                        return video_path

                # Ø§Ú¯Ø± Ù‡ÛŒÚ† ÙØ§ÛŒÙ„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯
                debug_log("ÙØ§ÛŒÙ„ ÙˆÛŒØ¯ÛŒÙˆ Ù¾Ø³ Ø§Ø² Ø¯Ø§Ù†Ù„ÙˆØ¯ ÛŒØ§ÙØª Ù†Ø´Ø¯", "WARNING", {"id": info['id']})
                return None

            except Exception as extract_error:
                debug_log("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆÛŒØ¯ÛŒÙˆ", "ERROR", {
                    "error": str(extract_error),
                    "traceback": traceback.format_exc()
                })
                return None

    except Exception as e:
        debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆ Ø§Ø² Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…", "ERROR", {
            "error": str(e),
            "traceback": traceback.format_exc()
        })

        try:
            # Ø§Ø·Ù„Ø§Ø¹ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†
            notify_admin(f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆ Ø§Ø² Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…:\n{traceback.format_exc()}")
        except Exception as notify_error:
            debug_log("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø·Ù„Ø§Ø¹ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†", "ERROR", {"error": str(notify_error)})

        return None


# ğŸ“Œ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆ Ø§Ø² ÛŒÙˆØªÛŒÙˆØ¨
def download_youtube(link):
    try:
        # Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¹ØªØ¨Ø± Ø¨ÙˆØ¯Ù† Ù„ÛŒÙ†Ú©
        if not link or not isinstance(link, str):
            debug_log("Ù„ÛŒÙ†Ú© Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø¯Ø± download_youtube", "WARNING", {"link": str(link)})
            return None

        # Ø¨Ø±Ø±Ø³ÛŒ YoutubeDL
        if 'YoutubeDL' not in globals():
            debug_log("YoutubeDL Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª", "ERROR")
            return None

        # Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ
        try:
            clear_folder(VIDEO_FOLDER)
        except Exception as clear_error:
            debug_log("Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù¾ÙˆØ´Ù‡ ÙˆÛŒØ¯ÛŒÙˆ", "WARNING", {"error": str(clear_error)})
            # Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ… Ø­ØªÛŒ Ø§Ú¯Ø± Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´ÙˆØ¯

        debug_log(f"Ø´Ø±ÙˆØ¹ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ø² ÛŒÙˆØªÛŒÙˆØ¨: {link}", "INFO")

        ydl_opts = {
            'outtmpl': f'{VIDEO_FOLDER}/%(id)s.%(ext)s',
            'format': 'mp4/best',
            'quiet': False,
            'noplaylist': True,
            'ignoreerrors': True,  # Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ† Ø¨Ø±Ø®ÛŒ Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø¬Ø²Ø¦ÛŒ
        }

        with YoutubeDL(ydl_opts) as ydl:
            try:
                info = ydl.extract_info(link, download=True)

                if not info:
                    debug_log("Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª", "WARNING")
                    return None

                if not info.get('id'):
                    debug_log("Ø´Ù†Ø§Ø³Ù‡ ÙˆÛŒØ¯ÛŒÙˆ Ø¯Ø± Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø§Ù†Ù„ÙˆØ¯ ÛŒØ§ÙØª Ù†Ø´Ø¯", "WARNING", {"info": str(info)[:500]})
                    return None

                # Ú†Ú© Ú©Ø±Ø¯Ù† Ú†Ù†Ø¯ÛŒÙ† ÙØ±Ù…Øª ÙØ§ÛŒÙ„
                possible_extensions = ['mp4', 'webm', 'mkv', 'mov', 'avi']
                for ext in possible_extensions:
                    video_path = f"{VIDEO_FOLDER}/{info['id']}.{ext}"
                    if os.path.exists(video_path):
                        debug_log(f"ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯: {video_path}", "INFO", {
                            "file_size": os.path.getsize(video_path) / (1024 * 1024),
                            "format": ext
                        })
                        return video_path

                # Ø§Ú¯Ø± Ù‡ÛŒÚ† ÙØ§ÛŒÙ„ÛŒ Ø¨Ø§ Ù¾Ø³ÙˆÙ†Ø¯Ù‡Ø§ÛŒ Ù…Ø¹Ù…ÙˆÙ„ ÛŒØ§ÙØª Ù†Ø´Ø¯ØŒ Ø¨Ù‡ Ø¯Ù†Ø¨Ø§Ù„ ÙØ§ÛŒÙ„ Ø¨Ø§ Ù¾Ø³ÙˆÙ†Ø¯ Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø± Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…ÛŒâ€ŒÚ¯Ø±Ø¯ÛŒÙ…
                if info.get('ext'):
                    video_path = f"{VIDEO_FOLDER}/{info['id']}.{info['ext']}"
                    if os.path.exists(video_path):
                        debug_log(f"ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø§ ÙØ±Ù…Øª {info['ext']} Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯: {video_path}", "INFO")
                        return video_path

                # Ø¬Ø³ØªØ¬ÙˆÛŒ ÙØ§ÛŒÙ„ Ø¯Ø± Ù¾ÙˆØ´Ù‡ VIDEO_FOLDER Ø¨Ø§ ID ÙˆÛŒØ¯ÛŒÙˆ
                try:
                    video_files = [f for f in os.listdir(VIDEO_FOLDER) if info['id'] in f]
                    if video_files:
                        video_path = os.path.join(VIDEO_FOLDER, video_files[0])
                        debug_log(f"ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø§ Ù†Ø§Ù… {video_files[0]} ÛŒØ§ÙØª Ø´Ø¯", "INFO")
                        return video_path
                except Exception as search_error:
                    debug_log("Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬ÙˆÛŒ ÙØ§ÛŒÙ„ ÙˆÛŒØ¯ÛŒÙˆ", "WARNING", {"error": str(search_error)})

                # Ø§Ú¯Ø± Ù‡ÛŒÚ† ÙØ§ÛŒÙ„ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯
                debug_log("ÙØ§ÛŒÙ„ ÙˆÛŒØ¯ÛŒÙˆ Ù¾Ø³ Ø§Ø² Ø¯Ø§Ù†Ù„ÙˆØ¯ ÛŒØ§ÙØª Ù†Ø´Ø¯", "WARNING", {"id": info['id']})
                return None

            except Exception as extract_error:
                debug_log("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆÛŒØ¯ÛŒÙˆ", "ERROR", {
                    "error": str(extract_error),
                    "traceback": traceback.format_exc()
                })
                return None

    except Exception as e:
        debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆ Ø§Ø² ÛŒÙˆØªÛŒÙˆØ¨", "ERROR", {
            "error": str(e),
            "traceback": traceback.format_exc()
        })

        try:
            # Ø§Ø·Ù„Ø§Ø¹ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†
            notify_admin(f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆ Ø§Ø² ÛŒÙˆØªÛŒÙˆØ¨:\n{traceback.format_exc()}")
        except Exception as notify_error:
            debug_log("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø·Ù„Ø§Ø¹ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†", "ERROR", {"error": str(notify_error)})

        return None


# ğŸ“¢ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† Ø¯Ø± ØµÙˆØ±Øª ÙˆÙ‚ÙˆØ¹ Ø®Ø·Ø§
def notify_admin(message):
    try:
        if bot is None:
            print("âš ï¸ Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù… Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³ØªØŒ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯")
            return

        # Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø·ÙˆÙ„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ 4000 Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø±Ø§ÛŒ Ø±Ø¹Ø§ÛŒØª Ù…Ø­Ø¯ÙˆØ¯ÛŒØªâ€ŒÙ‡Ø§ÛŒ ØªÙ„Ú¯Ø±Ø§Ù…
        message_text = str(message)[:4000]

        # Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¹ØªØ¨Ø± Ø¨ÙˆØ¯Ù† ADMIN_CHAT_ID
        if not ADMIN_CHAT_ID:
            print("âš ï¸ Ø¢ÛŒØ¯ÛŒ Ú†Øª Ø§Ø¯Ù…ÛŒÙ† ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª")
            return

        bot.send_message(ADMIN_CHAT_ID, message_text)
    except Exception as e:
        print(f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†: {e}")
        debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†", "ERROR", {
            "error": str(e),
            "admin_id": ADMIN_CHAT_ID,
            "message_length": len(str(message))
        })


# ğŸ¬ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯
def process_video_link(message, link, processing_msg):
    """
    Ø¯Ø§Ù†Ù„ÙˆØ¯ Ùˆ Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ¯ÛŒÙˆ Ø§Ø² Ù„ÛŒÙ†Ú© Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡
    Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø¯Ø± ÛŒÚ© ØªØ±Ø¯ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯ ØªØ§ Ø±Ø¨Ø§Øª Ø­ÛŒÙ† Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù¾Ø§Ø³Ø®Ú¯Ùˆ Ø¨Ø§Ø´Ø¯
    """
    global last_cleanup_time
    current_time = time.time()

    try:
        # Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø± - Ù‡Ø± ÛŒÚ© Ø¯Ù‚ÛŒÙ‚Ù‡ ÛŒÚ©Ø¨Ø§Ø± Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
        if current_time - last_cleanup_time > 60:  # Ù‡Ø± 60 Ø«Ø§Ù†ÛŒÙ‡
            debug_log("Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø§ØªÙˆÙ…Ø§ØªÛŒÚ© ÙÙˆÙ„Ø¯Ø±Ù‡Ø§ÛŒ ÙˆÛŒØ¯ÛŒÙˆ", "INFO")
            clear_folder(VIDEO_FOLDER, 0)  # Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„
            clear_folder(INSTAGRAM_FOLDER, 0)  # Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„
            last_cleanup_time = current_time

        # Ø¯Ø±ÛŒØ§ÙØª Ú©ÛŒÙÛŒØª ÙˆÛŒØ¯ÛŒÙˆ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø±
        user_id = str(message.from_user.id)
        quality = DEFAULT_VIDEO_QUALITY  # Ú©ÛŒÙÛŒØª Ù¾ÛŒØ´â€ŒÙØ±Ø¶

        if hasattr(bot, "user_video_quality") and user_id in bot.user_video_quality:
            quality = bot.user_video_quality[user_id]

        # Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
        bot.edit_message_text(
            f"â³ Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø§ Ú©ÛŒÙÛŒØª <b>{quality}</b>...",
            message.chat.id,
            processing_msg.message_id,
            parse_mode="HTML"
        )

        # ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù‡Ø´ Ù…ØµØ±Ù Ù…Ù†Ø§Ø¨Ø¹
        direct_url = get_direct_video_url(link)
        if direct_url and not "instagram.com" in link:  # Ø¨Ø±Ø§ÛŒ ÛŒÙˆØªÛŒÙˆØ¨ Ùˆ Ø³Ø§ÛŒØ± Ø³Ø§ÛŒØªâ€ŒÙ‡Ø§
            try:
                bot.edit_message_text(
                    f"âœ… Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… Ù¾ÛŒØ¯Ø§ Ø´Ø¯! Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§ Ú©ÛŒÙÛŒØª <b>{quality}</b>...",
                    message.chat.id,
                    processing_msg.message_id,
                    parse_mode="HTML"
                )

                # Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø§ Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ…
                bot.send_message(
                    message.chat.id,
                    f"ğŸ¬ <b>ÙˆÛŒØ¯ÛŒÙˆÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ Ø´Ù…Ø§</b>\n\nğŸ“Š Ú©ÛŒÙÛŒØª: <b>{quality}</b>\n\nğŸ”— <a href='{direct_url}'>Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… Ø¯Ø§Ù†Ù„ÙˆØ¯</a>",
                    parse_mode="HTML",
                    disable_web_page_preview=False
                )

                # Ø­Ø°Ù Ù¾ÛŒØ§Ù… "Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´"
                bot.delete_message(message.chat.id, processing_msg.message_id)
                return
            except Exception as direct_error:
                debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ…ØŒ Ø§Ø¯Ø§Ù…Ù‡ Ø±ÙˆÙ†Ø¯ Ø¯Ø§Ù†Ù„ÙˆØ¯", "WARNING", {"error": str(direct_error)})
                # Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ØŒ Ø¨Ù‡ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¹Ø§Ø¯ÛŒ Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…

        # ØªÙ†Ø¸ÛŒÙ… Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¨Ø§ Ú©ÛŒÙÛŒØª Ø§Ù†ØªØ®Ø§Ø¨ÛŒ
        format_option = VIDEO_QUALITIES.get(quality, VIDEO_QUALITIES["240p"])["format"]

        # Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†ÙˆØ¹ Ù„ÛŒÙ†Ú©
        if "instagram.com" in link:
            # Ø§Ú¯Ø± Ù„ÛŒÙ†Ú© Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… Ø§Ø³Øª
            ydl_opts = {
                'format': format_option,
                'outtmpl': f'{INSTAGRAM_FOLDER}/%(id)s.%(ext)s',
                'quiet': True,
                'noplaylist': True,
                'socket_timeout': 10,  # Ú©Ø§Ù‡Ø´ Ø²Ù…Ø§Ù† Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„
                'retries': 2,          # Ú©Ø§Ù‡Ø´ ØªØ¹Ø¯Ø§Ø¯ ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø¬Ø¯Ø¯
            }
            folder = INSTAGRAM_FOLDER
        else:
            # ÛŒÙˆØªÛŒÙˆØ¨ ÛŒØ§ Ø¯ÛŒÚ¯Ø± Ø³Ø§ÛŒØªâ€ŒÙ‡Ø§
            ydl_opts = {
                'format': format_option,
                'outtmpl': f'{VIDEO_FOLDER}/%(id)s.%(ext)s',
                'quiet': True,
                'noplaylist': True,
                'socket_timeout': 10,  # Ú©Ø§Ù‡Ø´ Ø²Ù…Ø§Ù† Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„
                'retries': 2,          # Ú©Ø§Ù‡Ø´ ØªØ¹Ø¯Ø§Ø¯ ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø¬Ø¯Ø¯
            }
            folder = VIDEO_FOLDER

        # Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ
        clear_folder(folder)

        # Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆ
        with YoutubeDL(ydl_opts) as ydl:
            info = ydl.extract_info(link, download=True)

            # Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ ÙØ§ÛŒÙ„ ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„
            if info and info.get('id'):
                video_path = f"{folder}/{info['id']}.mp4"
                if not os.path.exists(video_path) and info.get('ext'):
                    video_path = f"{folder}/{info['id']}.{info['ext']}"

                # Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ¯ÛŒÙˆ
                if os.path.exists(video_path):
                    # Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
                    bot.edit_message_text(
                        f"âœ… Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ø§Ù…Ù„ Ø´Ø¯! Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø§ Ú©ÛŒÙÛŒØª <b>{quality}</b>...",
                        message.chat.id,
                        processing_msg.message_id,
                        parse_mode="HTML"
                    )

                    # Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§ÛŒØ² ÙØ§ÛŒÙ„
                    file_size_mb = os.path.getsize(video_path) / (1024 * 1024)

                    # ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
                    try:
                        if file_size_mb < 50:  # ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ù…ØªØ± Ø§Ø² 50MB Ø±Ø§ Ù…Ø³ØªÙ‚ÛŒÙ… Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                            with open(video_path, 'rb') as video_file:
                                bot.send_video(
                                    message.chat.id,
                                    video_file,
                                    caption=f"ğŸ¬ <b>{info.get('title', 'ÙˆÛŒØ¯ÛŒÙˆÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯Ù‡')}</b>\n\nğŸ“Š Ú©ÛŒÙÛŒØª: <b>{quality}</b>\nğŸ“ Ø­Ø¬Ù…: <b>{file_size_mb:.1f} MB</b>",
                                    parse_mode="HTML",
                                    timeout=60
                                )
                            # Ø­Ø°Ù Ù¾ÛŒØ§Ù… "Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´"
                            bot.delete_message(message.chat.id, processing_msg.message_id)

                            # Ø­Ø°Ù ÙÙˆØ±ÛŒ ÙØ§ÛŒÙ„ Ù¾Ø³ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù‡Ø´ Ù…ØµØ±Ù ÙØ¶Ø§
                            try:
                                os.remove(video_path)
                                debug_log(f"ÙØ§ÛŒÙ„ {video_path} Ù¾Ø³ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ø­Ø°Ù Ø´Ø¯", "INFO")
                            except Exception as rm_error:
                                debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ÙØ§ÛŒÙ„ Ù¾Ø³ Ø§Ø² Ø§Ø±Ø³Ø§Ù„", "WARNING", {"error": str(rm_error)})

                            return
                        else:
                            # Ø¨Ø±Ø§ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¨Ø²Ø±Ú¯ØªØ±ØŒ Ù‚Ø·Ø¹Ù‡â€ŒØ¨Ù†Ø¯ÛŒ ÛŒØ§ Ø±ÙˆØ´ Ø¯ÛŒÚ¯Ø±ÛŒ Ù†ÛŒØ§Ø² Ø§Ø³Øª
                            bot.edit_message_text(
                                f"âš ï¸ Ø³Ø§ÛŒØ² ÙØ§ÛŒÙ„ ({file_size_mb:.1f} MB) Ø¨ÛŒØ´ØªØ± Ø§Ø² Ù…Ø­Ø¯ÙˆØ¯ÛŒØª ØªÙ„Ú¯Ø±Ø§Ù… Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ú©ÛŒÙÛŒØª Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.",
                                message.chat.id,
                                processing_msg.message_id,
                                parse_mode="HTML"
                            )
                            # Ø­Ø°Ù ÙØ§ÛŒÙ„ Ø¨Ø²Ø±Ú¯
                            try:
                                os.remove(video_path)
                            except:
                                pass
                            return
                    except Exception as e:
                        bot.edit_message_text(
                            f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ¯ÛŒÙˆ: {str(e)}\n\nÙ„Ø·ÙØ§Ù‹ Ø¨Ø§ Ú©ÛŒÙÛŒØª Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.",
                            message.chat.id,
                            processing_msg.message_id
                        )
                        notify_admin(f"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø± {message.from_user.id}: {str(e)}")
                        return

            # Ø¬Ø³ØªØ¬ÙˆÛŒ ÙØ§ÛŒÙ„ Ø¯Ø± Ù¾ÙˆØ´Ù‡ Ø¨Ø§ ID ÙˆÛŒØ¯ÛŒÙˆ
            try:
                if info and info.get('id'):
                    video_files = [f for f in os.listdir(folder) if info['id'] in f]
                    if video_files:
                        video_path = os.path.join(folder, video_files[0])
                        debug_log(f"ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø§ Ù†Ø§Ù… {video_files[0]} ÛŒØ§ÙØª Ø´Ø¯", "INFO")

                        # Ø§Ø·Ù„Ø§Ø¹â€ŒØ±Ø³Ø§Ù†ÛŒ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
                        bot.edit_message_text(
                            f"âœ… Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ø§Ù…Ù„ Ø´Ø¯! Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø§ Ú©ÛŒÙÛŒØª <b>{quality}</b>...",
                            message.chat.id,
                            processing_msg.message_id,
                            parse_mode="HTML"
                        )

                        # Ø¨Ø±Ø±Ø³ÛŒ Ø³Ø§ÛŒØ² ÙØ§ÛŒÙ„
                        file_size_mb = os.path.getsize(video_path) / (1024 * 1024)

                        # ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
                        if file_size_mb < 50:
                            with open(video_path, 'rb') as video_file:
                                bot.send_video(
                                    message.chat.id,
                                    video_file,
                                    caption=f"ğŸ¬ <b>{info.get('title', 'ÙˆÛŒØ¯ÛŒÙˆÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯Ù‡')}</b>\n\nğŸ“Š Ú©ÛŒÙÛŒØª: <b>{quality}</b>\nğŸ“ Ø­Ø¬Ù…: <b>{file_size_mb:.1f} MB</b>",
                                    parse_mode="HTML",
                                    timeout=60
                                )
                            bot.delete_message(message.chat.id, processing_msg.message_id)
                            return
                        else:
                            bot.edit_message_text(
                                f"âš ï¸ Ø³Ø§ÛŒØ² ÙØ§ÛŒÙ„ ({file_size_mb:.1f} MB) Ø¨ÛŒØ´ØªØ± Ø§Ø² Ù…Ø­Ø¯ÙˆØ¯ÛŒØª ØªÙ„Ú¯Ø±Ø§Ù… Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ú©ÛŒÙÛŒØª Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.",
                                message.chat.id,
                                processing_msg.message_id,
                                parse_mode="HTML"
                            )
                            return
            except Exception as search_error:
                debug_log("Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬ÙˆÛŒ ÙØ§ÛŒÙ„ ÙˆÛŒØ¯ÛŒÙˆ", "WARNING", {"error": str(search_error)})

            # Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯
            bot.edit_message_text(
                "âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆ. Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ú©ÛŒÙÛŒØª Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯ ÛŒØ§ Ù„ÛŒÙ†Ú© Ø¯ÛŒÚ¯Ø±ÛŒ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.",
                message.chat.id,
                processing_msg.message_id
            )
    except Exception as e:
        # Ø¯Ø± ØµÙˆØ±Øª Ù‡Ø±Ú¯ÙˆÙ†Ù‡ Ø®Ø·Ø§
        error_msg = f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙˆÛŒØ¯ÛŒÙˆ: {str(e)}"
        try:
            bot.edit_message_text(
                error_msg,
                message.chat.id,
                processing_msg.message_id
            )
        except:
            bot.send_message(message.chat.id, error_msg)

        # Ø§Ø·Ù„Ø§Ø¹ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†
        notify_admin(f"Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù„ÛŒÙ†Ú© ÙˆÛŒØ¯ÛŒÙˆ:\n{traceback.format_exc()}")


# ğŸ® Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù„ÛŒØ¯Ù‡Ø§ÛŒ Ù…ÛŒØ§Ù†Ø¨Ø± (Callback Query) Ùˆ Ø§Ù†ØªØ®Ø§Ø¨ Ú©ÛŒÙÛŒØª ÙˆÛŒØ¯ÛŒÙˆ
@bot.callback_query_handler(func=lambda call: True)
def handle_callback_query(call):
    try:
        # Ù¾Ø§Ø³Ø® Ø³Ø±ÛŒØ¹ Ø¨Ù‡ Ú©Ø§Ù„Ø¨Ú© Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®Ø·Ø§ÛŒ Ø³Ø§Ø¹Øª Ø´Ù†ÛŒ
        bot.answer_callback_query(call.id)

        # ğŸ”– Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù‡Ø´ØªÚ¯
        if call.data == "hashtag_help":
            # Ø§ÛŒØ¬Ø§Ø¯ Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø§ÛŒÙ†Ù„Ø§ÛŒÙ† Ø¨Ø§ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
            markup = telebot.types.InlineKeyboardMarkup()
            back_btn = telebot.types.InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="back_to_help")
            markup.add(back_btn)

            # Ø§Ø±Ø³Ø§Ù„ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù‡Ø´ØªÚ¯
            bot.edit_message_text(
                "ğŸ”– <b>Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§</b>\n\n"
                "Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù‚Ø§Ø¨Ù„ÛŒØª Ù‡Ø´ØªÚ¯ØŒ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ ØªÙ„Ú¯Ø±Ø§Ù… Ø±Ø§ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒØ¯.\n\n"
                "<b>Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø´ØªÚ¯:</b>\n"
                "â€¢ <code>/add_hashtag Ù†Ø§Ù…_Ù‡Ø´ØªÚ¯ ØªÙˆØ¶ÛŒØ­Ø§Øª</code> - Ø§ÙØ²ÙˆØ¯Ù† ÛŒÚ© Ù‡Ø´ØªÚ¯ Ø¬Ø¯ÛŒØ¯\n"
                "â€¢ <code>/remove_hashtag Ù†Ø§Ù…_Ù‡Ø´ØªÚ¯</code> - Ø­Ø°Ù ÛŒÚ© Ù‡Ø´ØªÚ¯\n"
                "â€¢ <code>/hashtags</code> - Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯\n\n"
                "<b>Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù†Ø§Ù„:</b>\n"
                "â€¢ <code>/add_channel Ø¢ÛŒØ¯ÛŒ_Ú©Ø§Ù†Ø§Ù„</code> - Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ù†Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬Ùˆ\n"
                "â€¢ <code>/remove_channel Ø¢ÛŒØ¯ÛŒ_Ú©Ø§Ù†Ø§Ù„</code> - Ø­Ø°Ù Ú©Ø§Ù†Ø§Ù„ Ø§Ø² Ù„ÛŒØ³Øª Ø¬Ø³ØªØ¬Ùˆ\n"
                "â€¢ <code>/channels</code> - Ù†Ù…Ø§ÛŒØ´ Ù„ÛŒØ³Øª Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯\n\n"
                "<b>Ø¬Ø³ØªØ¬ÙˆÛŒ Ù‡Ø´ØªÚ¯:</b>\n"
                "â€¢ <code>/search Ù†Ø§Ù…_Ù‡Ø´ØªÚ¯</code> - Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù†Ø§Ù„ Ø¨Ø§ Ù‡Ø´ØªÚ¯ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø±\n\n"
                "<b>ØªÙˆØ¬Ù‡:</b> Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØªØŒ Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ ÛŒÚ© Ù‡Ø´ØªÚ¯ Ùˆ ÛŒÚ© Ú©Ø§Ù†Ø§Ù„ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.",
                call.message.chat.id,
                call.message.message_id,
                parse_mode="HTML",
                reply_markup=markup
            )
            return

        # ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø±Ø§Ù‡Ù†Ù…Ø§
        if call.data == "back_to_help":
            # Ø§ÛŒØ¬Ø§Ø¯ Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø§ÛŒÙ†Ù„Ø§ÛŒÙ† Ø¨Ø§ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
            markup = telebot.types.InlineKeyboardMarkup(row_width=2)
            quality_btn = telebot.types.InlineKeyboardButton("ğŸ“Š Ø§Ù†ØªØ®Ø§Ø¨ Ú©ÛŒÙÛŒØª ÙˆÛŒØ¯ÛŒÙˆ", callback_data="select_quality")
            hashtag_btn = telebot.types.InlineKeyboardButton("ğŸ”– Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù‡Ø´ØªÚ¯", callback_data="hashtag_help")
            markup.add(quality_btn, hashtag_btn)

            # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø±Ø§Ù‡Ù†Ù…Ø§
            bot.edit_message_text(
                "ğŸ”° <b>Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±Ø¨Ø§Øª</b>\n\n"
                "ğŸ“Œ <b>Ø¯Ø³ØªÙˆØ±Ø§Øª Ø§ØµÙ„ÛŒ:</b>\n"
                "/start - Ø´Ø±ÙˆØ¹ Ú©Ø§Ø± Ø¨Ø§ Ø±Ø¨Ø§Øª\n"
                "/help - Ù†Ù…Ø§ÛŒØ´ Ø§ÛŒÙ† Ø±Ø§Ù‡Ù†Ù…Ø§\n"
                "/server_status - Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±\n\n"
                "ğŸ“¥ <b>Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆ:</b>\n"
                "â€¢ Ú©Ø§ÙÛŒØ³Øª Ù„ÛŒÙ†Ú© ÙˆÛŒØ¯ÛŒÙˆÛŒ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ø² ÛŒÙˆØªÛŒÙˆØ¨ ÛŒØ§ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯\n"
                "â€¢ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ú©ÛŒÙÛŒØª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ø² Ù…Ù†ÙˆÛŒ Ø²ÛŒØ± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯\n\n"
                "ğŸ”– <b>Ø¬Ø³ØªØ¬ÙˆÛŒ Ù‡Ø´ØªÚ¯:</b>\n"
                "â€¢ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ù‡Ø´ØªÚ¯â€ŒÙ‡Ø§ Ø§Ø² Ø¯Ø³ØªÙˆØ±Ø§Øª /add_hashtagØŒ /remove_hashtag Ùˆ /hashtags Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯\n"
                "â€¢ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ø§Ø² Ø¯Ø³ØªÙˆØ±Ø§Øª /add_channelØŒ /remove_channel Ùˆ /channels Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯\n"
                "â€¢ Ø¨Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬ÙˆÛŒ Ù‡Ø´ØªÚ¯ Ø¯Ø± Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ø§Ø² Ø¯Ø³ØªÙˆØ± /search Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯\n\n"
                "âš ï¸ <b>Ù†Ú©Ø§Øª Ù…Ù‡Ù…:</b>\n"
                "â€¢ Ø¨Ø±Ø§ÛŒ ØµØ±ÙÙ‡â€ŒØ¬ÙˆÛŒÛŒ Ø¯Ø± Ø­Ø¬Ù… Ø§ÛŒÙ†ØªØ±Ù†Øª Ùˆ Ø³Ø±Ø¹Øª Ø¨Ø§Ù„Ø§ØªØ±ØŒ Ø§Ø² Ú©ÛŒÙÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯\n"
                "â€¢ Ú©ÛŒÙÛŒØª Ù¾ÛŒØ´â€ŒÙØ±Ø¶ 240p Ø§Ø³Øª\n"
                "â€¢ ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ÛŒ Ø¨Ø§Ù„Ø§ÛŒ 50MB Ù‚Ø§Ø¨Ù„ Ø§Ø±Ø³Ø§Ù„ Ù†ÛŒØ³ØªÙ†Ø¯ Ùˆ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ú©ÛŒÙÛŒØª Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´ÙˆÙ†Ø¯",
                call.message.chat.id,
                call.message.message_id,
                parse_mode="HTML",
                reply_markup=markup
            )
            return

        # ğŸ“Š ØªØºÛŒÛŒØ± Ú©ÛŒÙÛŒØª ÙˆÛŒØ¯ÛŒÙˆ
        if call.data.startswith("quality_"):
            quality = call.data.replace("quality_", "")

            # ØªØ§ÛŒÛŒØ¯ ØªØºÛŒÛŒØ± Ú©ÛŒÙÛŒØª
            bot.edit_message_text(
                f"âœ… Ú©ÛŒÙÛŒØª ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ù‡ <b>{quality}</b> ØªØºÛŒÛŒØ± ÛŒØ§ÙØª!\n\n"
                "Ø§Ú©Ù†ÙˆÙ† Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù„ÛŒÙ†Ú© ÙˆÛŒØ¯ÛŒÙˆÛŒ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.",
                call.message.chat.id, 
                call.message.message_id,
                parse_mode="HTML"
            )

            # Ø°Ø®ÛŒØ±Ù‡ Ú©ÛŒÙÛŒØª Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±
            user_id = str(call.from_user.id)
            if not hasattr(bot, "user_video_quality"):
                bot.user_video_quality = {}
            bot.user_video_quality[user_id] = quality

            return

        # ğŸŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±
        elif call.data == "server_status":
            try:
                # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… "Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ..."
                bot.edit_message_text(
                    "â³ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±...",
                    call.message.chat.id,
                    call.message.message_id
                )

                # Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ± Ø§Ø² Ú©Ø´
                try:
                    cached_status = get_cached_server_status()
                    if cached_status:
                        bot.edit_message_text(
                            cached_status,
                            call.message.chat.id,
                            call.message.message_id,
                            parse_mode="Markdown"
                        )
                        return
                except Exception as cache_error:
                    print(f"Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø´ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±: {cache_error}")

                # Ø³Ø§Ø®Øª Ù¾ÛŒØ§Ù… ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ… Ø¨Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø¨Ø®Ø´
                status_sections = []
                status_sections.append("ğŸ“Š **ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±:**\n")

                # ÙˆØ¶Ø¹ÛŒØª Ø±Ø¨Ø§Øª
                status_sections.append(f"ğŸ”¹ **ÙˆØ¶Ø¹ÛŒØª Ø±Ø¨Ø§Øª:** `ÙØ¹Ø§Ù„ âœ…`\n")
                
            except Exception as e:
                bot.edit_message_text(
                    f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±: {str(e)}",
                    call.message.chat.id,
                    call.message.message_id
                )
            
# ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªÙˆØ± /status
@bot.message_handler(commands=['status'])
def server_status_command(message):
    """Ø¯Ø³ØªÙˆØ± Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±"""
    from bot_status_handler import handle_status_command
    handle_status_command(bot, message)
        try:
            status_sections.append(f"ğŸ”¹ **Ø³ÛŒØ³ØªÙ… Ø¹Ø§Ù…Ù„:** `{platform.platform()}`\n")
            status_sections.append(f"ğŸ”¹ **Ù¾Ø§ÛŒØªÙˆÙ†:** `{platform.python_version()}`\n")
        except Exception as e:
            status_sections.append("ğŸ”¹ **Ø³ÛŒØ³ØªÙ… Ø¹Ø§Ù…Ù„:** `Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª`\n")
            debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÛŒØ³ØªÙ…: {e}", "ERROR")

        # CPU
        try:
            cpu_usage = psutil.cpu_percent(interval=1)
            status_sections.append(f"ğŸ”¹ **CPU:** `{cpu_usage}%`\n")
        except Exception as e:
            status_sections.append("ğŸ”¹ **CPU:** `Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª`\n")
            debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª CPU: {e}", "ERROR")

        # RAM
        try:
            ram = psutil.virtual_memory()
            status_sections.append(f"ğŸ”¹ **RAM:** `{ram.used / (1024**3):.2f}GB / {ram.total / (1024**3):.2f}GB`\n")
        except Exception as e:
            status_sections.append("ğŸ”¹ **RAM:** `Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª`\n")
            debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª RAM: {e}", "ERROR")

        # ÙØ¶Ø§ÛŒ Ø¯ÛŒØ³Ú©
        try:
            free_gb = shutil.disk_usage("/").free / (1024**3)
            status_sections.append(f"ğŸ”¹ **ÙØ¶Ø§ÛŒ Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡:** `{free_gb:.2f}GB`\n")
        except Exception as e:
            status_sections.append("ğŸ”¹ **ÙØ¶Ø§ÛŒ Ø¯ÛŒØ³Ú©:** `Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª`\n")
            debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÛŒØ³Ú©: {e}", "ERROR")

        # Ø²Ù…Ø§Ù† Ø³Ø±ÙˆØ±
        try:
            current_time = datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S")
            status_sections.append(f"ğŸ”¹ **Ø²Ù…Ø§Ù† Ø³Ø±ÙˆØ±:** `{current_time}`\n")
        except Exception as e:
            status_sections.append("ğŸ”¹ **Ø²Ù…Ø§Ù† Ø³Ø±ÙˆØ±:** `Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª`\n")
            debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø²Ù…Ø§Ù†: {e}", "ERROR")

        # Ù…Ø¯Øª Ø²Ù…Ø§Ù† Ø±ÙˆØ´Ù† Ø¨ÙˆØ¯Ù† Ø³Ø±ÙˆØ± Ø¨Ø§ psutil
        try:
            uptime_seconds = time.time() - psutil.boot_time()
            uptime_hours = uptime_seconds // 3600
            status_sections.append(f"ğŸ”¹ **Ù…Ø¯Øª Ø±ÙˆØ´Ù† Ø¨ÙˆØ¯Ù†:** `{int(uptime_hours)} Ø³Ø§Ø¹Øª`\n")
        except Exception as e:
            status_sections.append("ğŸ”¹ **Ù…Ø¯Øª Ø±ÙˆØ´Ù† Ø¨ÙˆØ¯Ù†:** `Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª`\n")
            debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª uptime: {e}", "ERROR")

        # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø¨Ú©Ù‡
        try:
            net_io = psutil.net_io_counters()
            sent_gb = net_io.bytes_sent / (1024**3)
            recv_gb = net_io.bytes_recv / (1024**3)
            status_sections.append(f"ğŸ”¹ **ØªØ±Ø§ÙÛŒÚ© Ø´Ø¨Ú©Ù‡:** `Ø§Ø±Ø³Ø§Ù„: {sent_gb:.2f}GB, Ø¯Ø±ÛŒØ§ÙØª: {recv_gb:.2f}GB`\n")
        except Exception as e:
            status_sections.append("ğŸ”¹ **ØªØ±Ø§ÙÛŒÚ© Ø´Ø¨Ú©Ù‡:** `Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª`\n")
            debug_log(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø¨Ú©Ù‡: {e}", "ERROR")

        # Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù†Ù‡Ø§ÛŒÛŒ
        bot.send_message(message.chat.id, "".join(status_sections), parse_mode="Markdown")

    except Exception as e:
        debug_log(f"Ø®Ø·Ø§ÛŒ Ú©Ù„ÛŒ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±: {e}", "ERROR")
        bot.send_message(message.chat.id, f"âš  Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±: {str(e)}")

# Ø§Ø¯Ø§Ù…Ù‡ Ú©Ø¯ Ù‚Ø¨Ù„ÛŒ...
                            if 'psutil' in globals():
                                try:
                                    uptime_seconds = time.time() - psutil.boot_time()
                                    uptime_hours = uptime_seconds // 3600
                                    status_sections.append(f"ğŸ”¹ **Ù…Ø¯Øª Ø±ÙˆØ´Ù† Ø¨ÙˆØ¯Ù†:** `{int(uptime_hours)} Ø³Ø§Ø¹Øª`\n")
                                except Exception as uptime_error:
                                    status_sections.append("ğŸ”¹ **Ù…Ø¯Øª Ø±ÙˆØ´Ù† Ø¨ÙˆØ¯Ù†:** `Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª`\n")
                                    print(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª uptime: {uptime_error}")
            except Exception as time_error:
                status_sections.append("ğŸ”¹ **Ø²Ù…Ø§Ù† Ø³Ø±ÙˆØ±:** `Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª`\n")
                print(f"Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø²Ù…Ø§Ù†: {time_error}")

                # ØªØ±Ú©ÛŒØ¨ Ø¨Ø®Ø´â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ§Ù…
                status_msg = "".join(status_sections)

                # Ø°Ø®ÛŒØ±Ù‡ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ± Ø¯Ø± ÛŒÚ© ÙØ§ÛŒÙ„ JSON Ø¨Ø±Ø§ÛŒ Ú©Ø´ Ú©Ø±Ø¯Ù†
                try:
                    with open("server_status.json", "w", encoding="utf-8") as file:
                        json.dump(
                            {
                                "timestamp": datetime.datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                                "status": status_msg
                            }, file)
                except Exception as cache_write_error:
                    print(f"Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ú©Ø´ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±: {cache_write_error}")

                # Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ
                markup = telebot.types.InlineKeyboardMarkup()
                markup.add(telebot.types.InlineKeyboardButton("ğŸ  Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ", callback_data="back_to_main"))

                bot.edit_message_text(
                    status_msg,
                    call.message.chat.id,
                    call.message.message_id,
                    parse_mode="Markdown",
                    reply_markup=markup
                )
            except Exception as e:
                error_message = f"âš  Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±: {str(e)}"
                try:
                    # ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… ÙØ¹Ù„ÛŒ
                    bot.edit_message_text(
                        error_message,
                        call.message.chat.id,
                        call.message.message_id
                    )
                except:
                    # Ø§Ú¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯ØŒ Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†
                    bot.send_message(call.message.chat.id, error_message)
            return

        # ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ
        elif call.data == "back_to_main":
            # Ø§ÛŒØ¬Ø§Ø¯ Ú©ÛŒØ¨ÙˆØ±Ø¯ Ø§ÛŒÙ†Ù„Ø§ÛŒÙ† Ø¨Ø§ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
            markup = telebot.types.InlineKeyboardMarkup(row_width=2)
            help_btn = telebot.types.InlineKeyboardButton("ğŸ“š Ø±Ø§Ù‡Ù†Ù…Ø§", callback_data="download_help")
            quality_btn = telebot.types.InlineKeyboardButton("ğŸ“Š Ú©ÛŒÙÛŒØª ÙˆÛŒØ¯ÛŒÙˆ", callback_data="select_quality")
            status_btn = telebot.types.InlineKeyboardButton("ğŸ“ˆ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±", callback_data="server_status")

            markup.add(help_btn, quality_btn)
            markup.add(status_btn)

            bot.edit_message_text(
                f"ğŸ‘‹ Ø³Ù„Ø§Ù… {call.from_user.first_name}!\n\n"
                "ğŸ¬ Ø¨Ù‡ Ø±Ø¨Ø§Øª Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆ Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.\n\n"
                "ğŸ”¸ <b>Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø±Ø¨Ø§Øª:</b>\n"
                "â€¢ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆ Ø§Ø² ÛŒÙˆØªÛŒÙˆØ¨ Ùˆ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…\n"
                "â€¢ Ø§Ù…Ú©Ø§Ù† Ø§Ù†ØªØ®Ø§Ø¨ Ú©ÛŒÙÛŒØª ÙˆÛŒØ¯ÛŒÙˆ\n"
                "â€¢ Ù¾Ø§Ø³Ø®â€ŒÚ¯ÙˆÛŒÛŒ Ø¨Ù‡ Ø³ÙˆØ§Ù„Ø§Øª Ù…ØªØ¯Ø§ÙˆÙ„\n\n"
                "ğŸ”¹ <b>Ø±ÙˆØ´ Ø§Ø³ØªÙØ§Ø¯Ù‡:</b>\n"
                "Ú©Ø§ÙÛŒØ³Øª Ù„ÛŒÙ†Ú© ÙˆÛŒØ¯ÛŒÙˆÛŒ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø² ÛŒÙˆØªÛŒÙˆØ¨ ÛŒØ§ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.",
                call.message.chat.id,
                call.message.message_id,
                parse_mode="HTML",
                reply_markup=markup
            )
            return

        # ğŸ“Š Ø§Ù†ØªØ®Ø§Ø¨ Ú©ÛŒÙÛŒØª ÙˆÛŒØ¯ÛŒÙˆ
        elif call.data == "select_quality":
            # Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ú©ÛŒÙÛŒØª
            markup = telebot.types.InlineKeyboardMarkup(row_width=3)
            quality_buttons = []
            for quality in ["144p", "240p", "360p", "480p", "720p", "1080p"]:
                quality_buttons.append(
                    telebot.types.InlineKeyboardButton(f"ğŸ“º {quality}", callback_data=f"quality_{quality}")
                )

            # Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ÛŒ 3ØªØ§ÛŒÛŒ
            for i in range(0, len(quality_buttons), 3):
                group = quality_buttons[i:i+3]
                markup.add(*group)

            # Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø²Ú¯Ø´Øª
            markup.add(telebot.types.InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="back_to_main"))

            bot.edit_message_text(
                "ğŸ“Š <b>Ø§Ù†ØªØ®Ø§Ø¨ Ú©ÛŒÙÛŒØª ÙˆÛŒØ¯ÛŒÙˆ</b>\n\n"
                "Ù„Ø·ÙØ§Ù‹ Ú©ÛŒÙÛŒØª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:\n\n"
                "âš ï¸ <b>Ù†Ú©Ø§Øª Ù…Ù‡Ù…:</b>\n"
                "â€¢ Ú©ÛŒÙÛŒØª Ø¨Ø§Ù„Ø§ØªØ± = Ø­Ø¬Ù… Ø¨ÛŒØ´ØªØ± Ùˆ Ø²Ù…Ø§Ù† Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø·ÙˆÙ„Ø§Ù†ÛŒâ€ŒØªØ±\n"
                "â€¢ Ú©ÛŒÙÛŒØª Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± = Ø­Ø¬Ù… Ú©Ù…ØªØ± Ùˆ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø³Ø±ÛŒØ¹â€ŒØªØ±\n"
                "â€¢ ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§ÛŒ Ø¨Ø§ Ø­Ø¬Ù… Ø¨ÛŒØ´ Ø§Ø² 50MB Ù‚Ø§Ø¨Ù„ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø± ØªÙ„Ú¯Ø±Ø§Ù… Ù†ÛŒØ³ØªÙ†Ø¯\n"
                "â€¢ Ú©ÛŒÙÛŒØª ÙØ¹Ù„ÛŒ: <b>" + (bot.user_video_quality.get(str(call.from_user.id), DEFAULT_VIDEO_QUALITY) if hasattr(bot, "user_video_quality") else DEFAULT_VIDEO_QUALITY) + "</b>",
                call.message.chat.id,
                call.message.message_id,
                parse_mode="HTML",
                reply_markup=markup
            )
            return

        # ğŸ“ Ù†Ù…Ø§ÛŒØ´ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯
        elif call.data == "download_help":
            help_text = (
                "ğŸ¬ <b>Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆ</b>\n\n"
                "<b>ğŸ”¹ Ø§Ù†ÙˆØ§Ø¹ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø´Ø¯Ù‡:</b>\n"
                "â€¢ ÛŒÙˆØªÛŒÙˆØ¨: Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ Ù…Ø¹Ù…ÙˆÙ„ÛŒØŒ Ú©ÙˆØªØ§Ù‡ Ùˆ Ù¾Ù„ÛŒâ€ŒÙ„ÛŒØ³Øª\n"
                "â€¢ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…: Ù¾Ø³Øªâ€ŒÙ‡Ø§ØŒ IGTVØŒ Ø±ÛŒÙ„Ø²\n\n"
                "<b>ğŸ”¸ Ù†Ú©Ø§Øª Ù…Ù‡Ù…:</b>\n"
                "â€¢ <b>Ú©ÛŒÙÛŒØª:</b> Ø¨Ø±Ø§ÛŒ ØµØ±ÙÙ‡â€ŒØ¬ÙˆÛŒÛŒ Ø¯Ø± Ù…ØµØ±Ù Ø¯Ø§Ø¯Ù‡ Ùˆ Ø³Ø±Ø¹Øª Ø¨ÛŒØ´ØªØ±ØŒ Ø§Ø² Ú©ÛŒÙÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯\n"
                "â€¢ <b>Ø²Ù…Ø§Ù† Ø¯Ø§Ù†Ù„ÙˆØ¯:</b> Ø¨Ø³ØªÙ‡ Ø¨Ù‡ Ø­Ø¬Ù… ÙˆÛŒØ¯ÛŒÙˆ Ùˆ Ú©ÛŒÙÛŒØª Ø§Ù†ØªØ®Ø§Ø¨ÛŒØŒ Ù…Ù…Ú©Ù† Ø§Ø³Øª ØªØ§ 2 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø²Ù…Ø§Ù† Ø¨Ø¨Ø±Ø¯\n"
                "â€¢ <b>Ø®Ø·Ø§Ù‡Ø§:</b> Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ØŒ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ Ø¨Ø§ Ú©ÛŒÙÛŒØª Ù¾Ø§ÛŒÛŒÙ†â€ŒØªØ± Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯\n\n"
                "<b>ğŸ”„ Ø±ÙˆØ´ Ø§Ø³ØªÙØ§Ø¯Ù‡:</b>\n"
                "1. Ú©ÛŒÙÛŒØª Ù…ÙˆØ±Ø¯Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯\n"
                "2. Ù„ÛŒÙ†Ú© Ø±Ø§ Ú©Ù¾ÛŒ Ùˆ Ø¨Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯\n"
                "3. Ù…Ù†ØªØ¸Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯ Ùˆ Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø§Ø´ÛŒØ¯"
            )

            # Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ú©ÛŒÙÛŒØª
            markup = telebot.types.InlineKeyboardMarkup(row_width=3)
            quality_buttons = []
            for quality in ["144p", "240p", "360p", "480p", "720p", "1080p"]:
                quality_buttons.append(
                    telebot.types.InlineKeyboardButton(f"ğŸ“º {quality}", callback_data=f"quality_{quality}")
                )

            # Ø§ÙØ²ÙˆØ¯Ù† Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ Ø¯Ø± Ú¯Ø±ÙˆÙ‡â€ŒÙ‡Ø§ÛŒ 3ØªØ§ÛŒÛŒ
            for i in range(0, len(quality_buttons), 3):
                group = quality_buttons[i:i+3]
                markup.add(*group)

            bot.edit_message_text(
                help_text,
                call.message.chat.id, 
                call.message.message_id,
                parse_mode="HTML",
                reply_markup=markup
            )
            return

        # ğŸ’» Ù†Ù…Ø§ÛŒØ´ Ú©Ø¯ Ø±Ø¨Ø§Øª Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†
        elif call.data == "view_bot_code":
            # ØªÙ†Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†
            if call.from_user.id != ADMIN_CHAT_ID:
                bot.send_message(call.message.chat.id, "â›” Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ú©Ø¯ Ø±Ø¨Ø§Øª Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯!")
                return

            # ÙÙ‡Ø±Ø³Øª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‚Ø§Ø¨Ù„ Ù†Ù…Ø§ÛŒØ´
            files = [
                ("bot.py", "Ú©Ø¯ Ø§ØµÙ„ÛŒ Ø±Ø¨Ø§Øª"),
                ("main.py", "ÙØ§ÛŒÙ„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²"),
                ("utils.py", "ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ"),
                ("requirements.txt", "ÙˆØ§Ø¨Ø³ØªÚ¯ÛŒâ€ŒÙ‡Ø§")
            ]

            markup = telebot.types.InlineKeyboardMarkup(row_width=1)
            for file_name, description in files:
                if os.path.exists(file_name):
                    markup.add(telebot.types.InlineKeyboardButton(
                        f"ğŸ“„ {file_name} - {description}", 
                        callback_data=f"show_file_{file_name}"
                    ))

            markup.add(telebot.types.InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="bot_status"))

            bot.send_message(
                call.message.chat.id,
                "ğŸ“‚ <b>Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ú©Ø¯ Ø±Ø¨Ø§Øª</b>\n\n"
                "Ù„Ø·ÙØ§Ù‹ ÙØ§ÛŒÙ„ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:",
                parse_mode="HTML",
                reply_markup=markup
            )
            return

        # ğŸ“„ Ù†Ù…Ø§ÛŒØ´ Ù…Ø­ØªÙˆØ§ÛŒ ÙØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†
        elif call.data.startswith("show_file_"):
            # ØªÙ†Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†
            if call.from_user.id != ADMIN_CHAT_ID:
                bot.send_message(call.message.chat.id, "â›” Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ú©Ø¯ Ø±Ø¨Ø§Øª Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯!")
                return

            file_name = call.data.replace("show_file_", "")

            if os.path.exists(file_name):
                try:
                    with open(file_name, "r", encoding="utf-8") as f:
                        code = f.read()

                    # Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ Ø¨Ø§ ÙØ±Ù…Øª Ù…Ù†Ø§Ø³Ø¨
                    if len(code) > 4000:
                        chunks = [code[i:i+4000] for i in range(0, len(code), 4000)]
                        for i, chunk in enumerate(chunks):
                            bot.send_message(
                                call.message.chat.id,
                                f"ğŸ“„ <b>{file_name}</b> (Ø¨Ø®Ø´ {i+1}/{len(chunks)})\n\n"
                                f"<pre><code>{chunk}</code></pre>",
                                parse_mode="HTML"
                            )
                    else:
                        bot.send_message(
                            call.message.chat.id,
                            f"ğŸ“„ <b>{file_name}</b>\n\n"
                            f"<pre><code>{code}</code></pre>",
                            parse_mode="HTML"
                        )

                    # Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø²Ú¯Ø´Øª
                    markup = telebot.types.InlineKeyboardMarkup()
                    markup.add(telebot.types.InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="view_bot_code"))

                    bot.send_message(
                        call.message.chat.id,
                        "Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ØŒ Ø¯Ú©Ù…Ù‡ Ø²ÛŒØ± Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯:",
                        reply_markup=markup
                    )
                except Exception as e:
                    bot.send_message(
                        call.message.chat.id,
                        f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ ÙØ§ÛŒÙ„ {file_name}: {str(e)}"
                    )
            else:
                bot.send_message(
                    call.message.chat.id,
                    f"âš ï¸ ÙØ§ÛŒÙ„ {file_name} ÛŒØ§ÙØª Ù†Ø´Ø¯!"
                )
            return

        # ğŸ” Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ù‚ÛŒÙ‚ Ø³ÛŒØ³ØªÙ…
        elif call.data == "detailed_system_info":
            # ØªÙ†Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ù…ÛŒÙ†
            if call.from_user.id != ADMIN_CHAT_ID:
                bot.send_message(call.message.chat.id, "â›” Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§ Ù†Ø¯Ø§Ø±ÛŒØ¯!")
                return

            try:
                # Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ù‚ÛŒÙ‚ Ø³ÛŒØ³ØªÙ…
                import psutil
                import platform
                import datetime

                # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÛŒØ³ØªÙ…
                system_info = {
                    "System": platform.system(),
                    "Platform": platform.platform(),
                    "Architecture": platform.architecture()[0],
                    "Machine": platform.machine(),
                    "Processor": platform.processor(),
                    "Python Version": platform.python_version(),
                }

                # Ø§Ø·Ù„Ø§Ø¹Ø§Øª CPU
                cpu_info = {
                    "Physical cores": psutil.cpu_count(logical=False),
                    "Logical cores": psutil.cpu_count(logical=True),
                    "Current frequency": f"{psutil.cpu_freq().current:.2f} MHz" if psutil.cpu_freq() else "N/A",
                    "Min frequency": f"{psutil.cpu_freq().min:.2f} MHz" if psutil.cpu_freq() and hasattr(psutil.cpu_freq(), 'min') else "N/A",
                    "Max frequency": f"{psutil.cpu_freq().max:.2f} MHz" if psutil.cpu_freq() and hasattr(psutil.cpu_freq(), 'max') else "N/A",
                    "CPU Usage Per Core": [f"{x}%" for x in psutil.cpu_percent(interval=1, percpu=True)],
                    "Total CPU Usage": f"{psutil.cpu_percent(interval=1)}%",
                }

                # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø§ÙØ¸Ù‡
                memory = psutil.virtual_memory()
                memory_info = {
                    "Total": f"{memory.total / (1024**3):.2f} GB",
                    "Available": f"{memory.available / (1024**3):.2f} GB",
                    "Used": f"{memory.used / (1024**3):.2f} GB ({memory.percent}%)",
                    "Buffers": f"{memory.buffers / (1024**3):.2f} GB" if hasattr(memory, 'buffers') else "N/A",
                    "Cached": f"{memory.cached / (1024**3):.2f} GB" if hasattr(memory, 'cached') else "N/A", 
                }

                # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÛŒØ³Ú©
                disk_info = {}
                for partition in psutil.disk_partitions():
                    try:
                        partition_usage = psutil.disk_usage(partition.mountpoint)
                        disk_info[partition.mountpoint] = {
                            "Total": f"{partition_usage.total / (1024**3):.2f} GB",
                            "Used": f"{partition_usage.used / (1024**3):.2f} GB ({partition_usage.percent}%)",
                            "Free": f"{partition_usage.free / (1024**3):.2f} GB",
                            "File system": partition.fstype,
                        }
                    except:
                        pass

                # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø¨Ú©Ù‡
                net_io = psutil.net_io_counters()
                network_info = {
                    "Bytes Sent": f"{net_io.bytes_sent / (1024**2):.2f} MB",
                    "Bytes Received": f"{net_io.bytes_recv / (1024**2):.2f} MB",
                    "Packets Sent": f"{net_io.packets_sent}",
                    "Packets Received": f"{net_io.packets_recv}",
                    "Errors (in/out)": f"{net_io.errin}/{net_io.errout}",
                    "Dropped (in/out)": f"{net_io.dropin}/{net_io.dropout}",
                }

                # Ù¾Ø±Ø¯Ø§Ø²Ø´â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ù…ØµØ±Ù CPU
                processes_by_cpu = []
                for proc in psutil.process_iter(['pid', 'name', 'username', 'cpu_percent', 'memory_percent', 'create_time']):
                    try:
                        if proc.info['cpu_percent'] > 0.5:  # ÙÙ‚Ø· Ù¾Ø±Ø¯Ø§Ø²Ø´â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ Ù…ØµØ±Ù Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² 0.5%
                            proc_info = proc.info
                            proc_info['create_time'] = datetime.datetime.fromtimestamp(proc_info['create_time']).strftime('%Y-%m-%d %H:%M:%S')
                            processes_by_cpu.append(proc_info)
                    except (psutil.NoSuchProcess, psutil.AccessDenied, psutil.ZombieProcess):
                        pass

                # Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ØµØ±Ù CPU (Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø§ÙˆÙ„)
                processes_by_cpu.sort(key=lambda x: x['cpu_percent'], reverse=True)

                # Ù¾Ø±Ø¯Ø§Ø²Ø´â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ù…ØµØ±Ù Ø­Ø§ÙØ¸Ù‡
                processes_by_memory = []
                for proc in psutil.process_iter(['pid', 'name', 'username', 'cpu_percent', 'memory_percent', 'create_time']):
                    try:
                        if proc.info['memory_percent'] > 0.5:  # ÙÙ‚Ø· Ù¾Ø±Ø¯Ø§Ø²Ø´â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ Ù…ØµØ±Ù Ø¨Ø§Ù„Ø§ØªØ± Ø§Ø² 0.5%
                            proc_info = proc.info
                            proc_info['create_time'] = datetime.datetime.fromtimestamp(proc_info['create_time']).strftime('%Y-%m-%d %H:%M:%S')
                            processes_by_memory.append(proc_info)
                    except (psutil.NoSuchProcess, psutil.AccessDenied, psutil.ZombieProcess):
                        pass

                # Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ Ù¾Ø±Ø¯Ø§Ø²Ø´â€ŒÙ‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù…ØµØ±Ù Ø­Ø§ÙØ¸Ù‡ (Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø§ÙˆÙ„)
                processes_by_memory.sort(key=lambda x: x['memory_percent'], reverse=True)

                # Ø§ÛŒØ¬Ø§Ø¯ Ù…ØªÙ† Ú¯Ø²Ø§Ø±Ø´
                report = "ğŸ“Š <b>Ú¯Ø²Ø§Ø±Ø´ Ø¯Ù‚ÛŒÙ‚ Ø³ÛŒØ³ØªÙ…</b>\n\n"

                # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÛŒØ³ØªÙ…
                report += "<b>ğŸ’» Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø³ÛŒØ³ØªÙ…:</b>\n"
                for key, value in system_info.items():
                    report += f"â€¢ {key}: {value}\n"

                # Ø§Ø·Ù„Ø§Ø¹Ø§Øª CPU
                report += "\n<b>ğŸ”§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª CPU:</b>\n"
                for key, value in cpu_info.items():
                    if key == "CPU Usage Per Core":
                        report += f"â€¢ Ù…ØµØ±Ù Ù‡Ø± Ù‡Ø³ØªÙ‡: {', '.join(value[:4])}... \n"
                    else:
                        report += f"â€¢ {key}: {value}\n"

                # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø§ÙØ¸Ù‡
                report += "\n<b>ğŸ§  Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ø§ÙØ¸Ù‡:</b>\n"
                for key, value in memory_info.items():
                    report += f"â€¢ {key}: {value}\n"

                # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÛŒØ³Ú© (ÙÙ‚Ø· Ø±ÛŒØ´Ù‡)
                report += "\n<b>ğŸ’½ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÛŒØ³Ú©:</b>\n"
                root_partition = '/' if '/' in disk_info else list(disk_info.keys())[0]
                for key, value in disk_info[root_partition].items():
                    report += f"â€¢ {key}: {value}\n"

                # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø¨Ú©Ù‡
                report += "\n<b>ğŸŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø¨Ú©Ù‡:</b>\n"
                for key, value in network_info.items():
                    report += f"â€¢ {key}: {value}\n"

                # Ù¾Ø±Ø¯Ø§Ø²Ø´â€ŒÙ‡Ø§ÛŒ Ø¨Ø±ØªØ± Ø§Ø² Ù†Ø¸Ø± CPU
                report += "\n<b>ğŸ”„ Ù¾Ø±Ø¯Ø§Ø²Ø´â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ù…ØµØ±Ù CPU:</b>\n"
                for i, proc in enumerate(processes_by_cpu[:5], 1):
                    report += f"â€¢ {i}. {proc['name']} (PID: {proc['pid']}): {proc['cpu_percent']:.1f}% CPU, {proc['memory_percent']:.1f}% RAM\n"

                # Ù¾Ø±Ø¯Ø§Ø²Ø´â€ŒÙ‡Ø§ÛŒ Ø¨Ø±ØªØ± Ø§Ø² Ù†Ø¸Ø± Ø­Ø§ÙØ¸Ù‡
                report += "\n<b>ğŸ”„ Ù¾Ø±Ø¯Ø§Ø²Ø´â€ŒÙ‡Ø§ÛŒ Ø¨Ø§ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ù…ØµØ±Ù Ø­Ø§ÙØ¸Ù‡:</b>\n"
                for i, proc in enumerate(processes_by_memory[:5], 1):
                    report += f"â€¢ {i}. {proc['name']} (PID: {proc['pid']}): {proc['memory_percent']:.1f}% RAM, {proc['cpu_percent']:.1f}% CPU\n"

                # Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§
                boot_time = datetime.datetime.fromtimestamp(psutil.boot_time())
                uptime = datetime.datetime.now() - boot_time
                uptime_str = f"{uptime.days} Ø±ÙˆØ²ØŒ {uptime.seconds // 3600} Ø³Ø§Ø¹ØªØŒ {(uptime.seconds // 60) % 60} Ø¯Ù‚ÛŒÙ‚Ù‡"
                report += f"\n<b>â±ï¸ Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§:</b> {uptime_str}"
                report += f"\n<b>ğŸ“… Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹ Ø³ÛŒØ³ØªÙ…:</b> {boot_time.strftime('%Y-%m-%d %H:%M:%S')}"

                # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø²Ú¯Ø´Øª
                markup = telebot.types.InlineKeyboardMarkup()
                markup.add(telebot.types.InlineKeyboardButton("ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ", callback_data="detailed_system_info"))
                markup.add(telebot.types.InlineKeyboardButton("ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª", callback_data="bot_status"))

                # Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´
                bot.send_message(
                    call.message.chat.id,
                    report,
                    parse_mode="HTML",
                    reply_markup=markup
                )
            except Exception as e:
                bot.send_message(
                    call.message.chat.id,
                    f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± ØªÙ‡ÛŒÙ‡ Ú¯Ø²Ø§Ø±Ø´ Ø³ÛŒØ³ØªÙ…: {str(e)}"
                )
            return

        # Ø¯Ø± ØµÙˆØ±ØªÛŒ Ú©Ù‡ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù†Ø´Ø¯ØŒ Ø¨Ù‡ ØªØ§Ø¨Ø¹ handle_callback Ø§ØµÙ„ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø´ÙˆØ¯
        if hasattr(bot, "original_handle_callback"):
            bot.original_handle_callback(call)

    except Exception as e:
        notify_admin(f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ø§Ù„Ø¨Ú©: {str(e)}")

# ğŸ“© Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØªÛŒ
@bot.message_handler(func=lambda message: True)
def handle_message(message):
    try:
        # Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ† Ú©Ù‡ Ù¾ÛŒØ§Ù… Ù…ØªÙ†ÛŒ Ø¨Ø§Ø´Ø¯
        if not hasattr(message, 'text') or not message.text:
            debug_log("Ù¾ÛŒØ§Ù… ØºÛŒØ± Ù…ØªÙ†ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯", "INFO", {
                "chat_id": message.chat.id, 
                "content_type": message.content_type if hasattr(message, 'content_type') else "Ù†Ø§Ù…Ø´Ø®Øµ"
            })
            return

        # Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ ÙØ±Ø³ØªÙ†Ø¯Ù‡â€ŒÛŒ Ù¾ÛŒØ§Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ø´Ø¯
        if not hasattr(message, 'from_user') or not message.from_user:
            debug_log("Ù¾ÛŒØ§Ù… Ø¨Ø¯ÙˆÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±Ø³ØªÙ†Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯", "WARNING")
            return

        text = message.text.strip()

        # Ù„Ø§Ú¯ Ú©Ø±Ø¯Ù† Ù¾ÛŒØ§Ù… Ø¯Ø±ÛŒØ§ÙØªÛŒ
        debug_log(f"Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯", "INFO", {
            "chat_id": message.chat.id,
            "user_id": message.from_user.id,
            "text_length": len(text),
            "has_link": "instagram.com" in text or "youtube.com" in text or "youtu.be" in text
        })

        # Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ ÙˆÛŒØ¯ÛŒÙˆ
        if "instagram.com" in text or "youtube.com" in text or "youtu.be" in text:
            # Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´
            try:
                processing_msg = bot.reply_to(message, "â³ Ø¯Ø±Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù„ÛŒÙ†Ú© ÙˆÛŒØ¯ÛŒÙˆ... (Ù…Ù…Ú©Ù† Ø§Ø³Øª ØªØ§ 2 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø·ÙˆÙ„ Ø¨Ú©Ø´Ø¯)")
            except Exception as reply_error:
                debug_log("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ù¾Ø§Ø³Ø®", "ERROR", {"error": str(reply_error)})
                try:
                    processing_msg = bot.send_message(message.chat.id, "â³ Ø¯Ø±Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù„ÛŒÙ†Ú© ÙˆÛŒØ¯ÛŒÙˆ... (Ù…Ù…Ú©Ù† Ø§Ø³Øª ØªØ§ 2 Ø¯Ù‚ÛŒÙ‚Ù‡ Ø·ÙˆÙ„ Ø¨Ú©Ø´Ø¯)")
                except Exception as send_error:
                    debug_log("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¬Ø¯ÛŒØ¯", "ERROR", {"error": str(send_error)})
                    return

            # Ø¯Ø±ÛŒØ§ÙØª Ú©ÛŒÙÛŒØª ÙˆÛŒØ¯ÛŒÙˆ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø±
            user_id = str(message.from_user.id)
            quality = DEFAULT_VIDEO_QUALITY  # Ú©ÛŒÙÛŒØª Ù¾ÛŒØ´â€ŒÙØ±Ø¶

            try:
                if hasattr(bot, "user_video_quality") and user_id in bot.user_video_quality:
                    quality = bot.user_video_quality[user_id]

                debug_log(f"Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù„ÛŒÙ†Ú© ÙˆÛŒØ¯ÛŒÙˆ Ø¢ØºØ§Ø² Ø´Ø¯", "INFO", {
                    "user_id": user_id,
                    "quality": quality,
                    "link": text[:100]  # Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø·ÙˆÙ„ Ù„ÛŒÙ†Ú© Ø¯Ø± Ù„Ø§Ú¯
                })
            except Exception as quality_error:
                debug_log("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ú©ÛŒÙÛŒØª ÙˆÛŒØ¯ÛŒÙˆ", "WARNING", {"error": str(quality_error)})

            # ØªÙ†Ø¸ÛŒÙ… Ú¯Ø²ÛŒÙ†Ù‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯
            ydl_opts = {
                'format': VIDEO_QUALITIES.get(quality, VIDEO_QUALITIES["240p"])["format"],
                'quiet': True,
                'noplaylist': True,
                'ignoreerrors': True
            }

            # Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… (Ø³Ø±ÛŒØ¹â€ŒØªØ±ÛŒÙ† Ø±ÙˆØ´)
            direct_method_success = False
            try:
                direct_url = get_direct_video_url(text)
                if direct_url:
                    debug_log("Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯", "INFO")
                    try:
                        bot.edit_message_text("âœ… ÙˆÛŒØ¯ÛŒÙˆ ÛŒØ§ÙØª Ø´Ø¯! Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...", message.chat.id, processing_msg.message_id)
                        bot.send_video(chat_id=message.chat.id, video=direct_url, timeout=60)
                        bot.delete_message(message.chat.id, processing_msg.message_id)
                        direct_method_success = True
                        debug_log("Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø§ Ø±ÙˆØ´ Ù…Ø³ØªÙ‚ÛŒÙ… Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ² Ø¨ÙˆØ¯", "INFO")
                        return
                    except Exception as send_error:
                        debug_log("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø§ Ø±ÙˆØ´ Ù…Ø³ØªÙ‚ÛŒÙ…", "WARNING", {"error": str(send_error)})
                        bot.edit_message_text("â³ Ø±ÙˆØ´ Ù…Ø³ØªÙ‚ÛŒÙ… Ù…ÙˆÙÙ‚ Ù†Ø¨ÙˆØ¯. Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø§ Ú©ÛŒÙÛŒØª Ø§Ù†ØªØ®Ø§Ø¨ÛŒ...", 
                                             message.chat.id, processing_msg.message_id)
            except Exception as direct_error:
                debug_log("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ…", "WARNING", {"error": str(direct_error)})

            # Ø§Ú¯Ø± Ø±ÙˆØ´ Ù…Ø³ØªÙ‚ÛŒÙ… Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯ØŒ Ø§Ø² Ø±ÙˆØ´ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            if not direct_method_success:
                try:
                    # Ø´Ø±ÙˆØ¹ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¯Ø± ÛŒÚ© thread Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø§Ù†Ø³Ø¯Ø§Ø¯
                    debug_log("Ø´Ø±ÙˆØ¹ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆ Ø¯Ø± ØªØ±Ø¯ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡", "INFO")
                    thread_pool.submit(process_video_link, message, text, processing_msg)
                except Exception as thread_error:
                    debug_log("Ø®Ø·Ø§ Ø¯Ø± Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ ØªØ±Ø¯ Ø¯Ø§Ù†Ù„ÙˆØ¯", "ERROR", {"error": str(thread_error)})
                    try:
                        bot.edit_message_text(f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙˆÛŒØ¯ÛŒÙˆ: {str(thread_error)[:100]}", 
                                            message.chat.id, processing_msg.message_id)
                    except:
                        pass

            return

        if "ØŸ" in text:
            # Ø§Ú¯Ø± Ù¾ÛŒØ§Ù… Ø´Ø§Ù…Ù„ "ØŸ" Ø¨Ø§Ø´Ø¯ØŒ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…Ø±Ø¨ÙˆØ·Ù‡ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯
            response = "Ø§ÛŒÙ† ÛŒÚ© Ø³ÙˆØ§Ù„ Ø§Ø³Øª."
            bot.reply_to(message, response)

        elif "ØŒ" in text:
            try:
                question, answer = map(str.strip, text.split("ØŒ", 1))

                # Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¹ØªØ¨Ø± Ø¨ÙˆØ¯Ù† Ø³ÙˆØ§Ù„ Ùˆ Ø¬ÙˆØ§Ø¨
                if not question or not answer:
                    bot.reply_to(message, "âš ï¸ Ø³ÙˆØ§Ù„ ÛŒØ§ Ø¬ÙˆØ§Ø¨ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯!")
                    return

                # Ù…Ø­Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ø·ÙˆÙ„ Ø³ÙˆØ§Ù„ Ùˆ Ø¬ÙˆØ§Ø¨
                question = question[:100] if len(question) > 100 else question
                answer = answer[:500] if len(answer) > 500 else answer

                # Ø°Ø®ÛŒØ±Ù‡ Ø¯Ø± Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§
                responses[question.lower()] = answer
                debug_log("Ù¾Ø§Ø³Ø® Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯", "INFO", {"question": question, "answer": answer})

                # Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ Ø¯Ø± ÙØ§ÛŒÙ„
                try:
                    save_responses()
                except Exception as save_error:
                    debug_log("Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§", "ERROR", {"error": str(save_error)})
                    bot.reply_to(message, "âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§. Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")
                    return

                bot.reply_to(message, f"âœ… Ø³ÙˆØ§Ù„ '{question}' Ø¨Ø§ Ù¾Ø§Ø³Ø® '{answer}' Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯!")

            except ValueError:
                bot.reply_to(message, "âš ï¸ Ù„Ø·ÙØ§Ù‹ ÙØ±Ù…Øª 'Ø³ÙˆØ§Ù„ØŒ Ø¬ÙˆØ§Ø¨' Ø±Ø§ Ø±Ø¹Ø§ÛŒØª Ú©Ù†ÛŒØ¯.")
            except Exception as reply_error:
                debug_log("Ø®Ø·Ø§ Ø¯Ø± Ø§ÙØ²ÙˆØ¯Ù† Ù¾Ø§Ø³Ø® Ø¬Ø¯ÛŒØ¯", "ERROR", {"error": str(reply_error)})
                bot.reply_to(message, "âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø±Ø®ÙˆØ§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.")

        else:
            bot.reply_to(message, "âš ï¸ Ù¾ÛŒØ§Ù… Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ ÙØ±Ù…Øª Ù…Ù†Ø§Ø³Ø¨ Ø±Ø§ Ø±Ø¹Ø§ÛŒØª Ú©Ù†ÛŒØ¯.")


            # Ú†Ú© Ú©Ø±Ø¯Ù† Ø§Ú¯Ø± Ù¾ÛŒØ§Ù… Ù…Ø·Ø§Ø¨Ù‚ Ø¨Ø§ ÛŒÚ©ÛŒ Ø§Ø² Ø³ÙˆØ§Ù„Ø§Øª Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª
            try:
                key = text.lower().strip()
                if key in responses:
                    debug_log(f"Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯Ú©Ø§Ø± Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯", "INFO", {"question": key})
                    bot.reply_to(message, responses[key])
                else:
                    # Ø§Ú¯Ø± Ù¾ÛŒØ§Ù… Ø´Ø§Ù…Ù„ Ø³Ù„Ø§Ù…ØŒ Ø®ÙˆØ¨ÛŒ Ùˆ ... Ø¨Ø§Ø´Ø¯ØŒ Ù¾Ø§Ø³Ø® Ù…Ù†Ø§Ø³Ø¨ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒÙ…
                    greetings = ['Ø³Ù„Ø§Ù…', 'Ø¯Ø±ÙˆØ¯', 'Ø®ÙˆØ¨ÛŒ', 'Ú†Ø·ÙˆØ±ÛŒ', 'Ø®ÙˆØ¨ÛŒÙ†', 'Ú†Ø·ÙˆØ±ÛŒ', 'Ø³Ù„Ø§Ù…', 'hi', 'hello']
                    if any(greeting in key for greeting in greetings):
                        debug_log("Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ø³Ù„Ø§Ù… Ú©Ø§Ø±Ø¨Ø±", "INFO")
                        bot.reply_to(message, f"ğŸ‘‹ Ø³Ù„Ø§Ù… {message.from_user.first_name}!\n\n"
                              "ğŸ¬ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ ÛŒÙˆØªÛŒÙˆØ¨ ÛŒØ§ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ ØªØ§ ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´ÙˆØ¯.\n\n"
                              "âœ… Ù‡Ù…Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†Ù†Ø¯!")  

                    # Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±ØªØŒ Ù„ÛŒÙ†Ú© Ø±Ø§Ù‡Ù†Ù…Ø§ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ù‡ÛŒÙ… (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®ØµÙˆØµÛŒ)
                    elif message.chat.type == 'private' and len(key) > 3:
                        debug_log("Ø§Ø±Ø³Ø§Ù„ Ø±Ø§Ù‡Ù†Ù…Ø§ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ§Ù… Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡", "INFO")
                        markup = telebot.types.InlineKeyboardMarkup()
                        help_btn = telebot.types.InlineKeyboardButton("ğŸ“š Ø±Ø§Ù‡Ù†Ù…Ø§", callback_data="download_help")
                        quality_btn = telebot.types.InlineKeyboardButton("ğŸ“Š Ú©ÛŒÙÛŒØª ÙˆÛŒØ¯ÛŒÙˆ", callback_data="select_quality")
                        markup.add(help_btn, quality_btn)
                        bot.reply_to(
                            message,
                            "Ø¨Ø±Ø§ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆØŒ Ú©Ø§ÙÛŒØ³Øª Ù„ÛŒÙ†Ú© ÛŒÙˆØªÛŒÙˆØ¨ ÛŒØ§ Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù… Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯ ğŸ¬",
                            reply_markup=markup
                        )
            except Exception as response_error:
                debug_log("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾Ø§Ø³Ø®", "ERROR", {"error": str(response_error)})

    except Exception as e:
        error_msg = f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù…:\n{traceback.format_exc()}"
        debug_log("Ø®Ø·Ø§ Ø¯Ø± ØªØ§Ø¨Ø¹ handle_message", "ERROR", {
            "error": str(e),
            "traceback": traceback.format_exc()
        })

        try:
            notify_admin(error_msg)
        except Exception as notify_error:
            debug_log("Ø®Ø·Ø§ Ø¯Ø± Ø§Ø·Ù„Ø§Ø¹ Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†", "ERROR", {"error": str(notify_error)})


def keep_awake():
    while True:
        # Ø¨Ø±Ø±Ø³ÛŒ Ù…Ù‚Ø¯Ø§Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² CPU
        cpu_usage = psutil.cpu_percent(interval=1)
        if cpu_usage < 5:  # Ø§Ú¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø´Ø¯ØŒ ÛŒÚ© Ø¹Ù…Ù„ÛŒØ§Øª Ú©ÙˆÚ†Ú© Ø§Ù†Ø¬Ø§Ù… Ø¨Ø¯Ù‡
            print("âœ… Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø®ÙˆØ§Ø¨ÛŒØ¯Ù† Ø±Ø¨Ø§Øª Ø¨Ø§ Ø§ÙØ²Ø§ÛŒØ´ Ù¾Ø±Ø¯Ø§Ø²Ø´")
            _ = [x**2 for x in range(10000)]  # Ø§Ù†Ø¬Ø§Ù… ÛŒÚ© Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©ÙˆÚ†Ú©

        time.sleep(300)  # â³ Ù‡Ø± 5 Ø¯Ù‚ÛŒÙ‚Ù‡ ÛŒÚ©â€ŒØ¨Ø§Ø± Ø¨Ø±Ø±Ø³ÛŒ Ø´ÙˆØ¯


# Ø§Ø¬Ø±Ø§ÛŒ ØªØ§Ø¨Ø¹ Ø¯Ø± ÛŒÚ© ØªØ±Ø¯ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡
threading.Thread(target=keep_awake, daemon=True).start()
LAST_USAGE = {"cpu": 0, "ram": 0}
high_usage_alert = {"cpu": False, "ram": False}  # ÙˆØ¶Ø¹ÛŒØª Ù‡Ø´Ø¯Ø§Ø± CPU Ùˆ RAM


def monitor_server():
    global LAST_USAGE, high_usage_alert
    while True:
        cpu_usage = psutil.cpu_percent(interval=1)
        ram_usage = psutil.virtual_memory().percent

        # Ø§Ú¯Ø± CPU Ø¨Ø§Ù„Ø§ÛŒ Û¸Û°Ùª Ø¨Ø§Ø´Ø¯ Ùˆ Ù‚Ø¨Ù„Ø§Ù‹ Ù‡Ø´Ø¯Ø§Ø± Ù†Ø¯Ø§Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
        if cpu_usage > 80:
            if not high_usage_alert["cpu"]:
                time.sleep(300)  # Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¨Ø¹Ø¯ Ø§Ø² 5 Ø¯Ù‚ÛŒÙ‚Ù‡
                cpu_recheck = psutil.cpu_percent(interval=1)
                if cpu_recheck > 80:  # Ù‡Ù†ÙˆØ² Ø¨Ø§Ù„Ø§ÛŒ Û¸Û°Ùª Ø§Ø³Øª
                    bot.send_message(
                        ADMIN_CHAT_ID,
                        f"âš  **Ù‡Ø´Ø¯Ø§Ø±: Ù…ØµØ±Ù CPU Ø¨Ø§Ù„Ø§ÛŒ Û¸Û°Ùª Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡!**\nğŸ”¹ **CPU:** {cpu_recheck}%"
                    )
                    high_usage_alert["cpu"] = True  # Ø«Ø¨Øª Ù‡Ø´Ø¯Ø§Ø±
        else:
            high_usage_alert[
                "cpu"] = False  # Ø§Ú¯Ø± CPU Ú©Ø§Ù‡Ø´ ÛŒØ§ÙØªØŒ Ù‡Ø´Ø¯Ø§Ø± Ø±Ø§ Ø±ÛŒØ³Øª Ú©Ù†

        # Ø§Ú¯Ø± RAM Ø¨Ø§Ù„Ø§ÛŒ Û¸Û°Ùª Ø¨Ø§Ø´Ø¯ Ùˆ Ù‚Ø¨Ù„Ø§Ù‹ Ù‡Ø´Ø¯Ø§Ø± Ù†Ø¯Ø§Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
        if ram_usage > 80:
            if not high_usage_alert["ram"]:
                time.sleep(300)  # Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¨Ø¹Ø¯ Ø§Ø² 5 Ø¯Ù‚ÛŒÙ‚Ù‡
                ram_recheck = psutil.virtual_memory().percent
                if ram_recheck > 80:  # Ù‡Ù†ÙˆØ² Ø¨Ø§Ù„Ø§ÛŒ Û¸Û°Ùª Ø§Ø³Øª
                    bot.send_message(
                        ADMIN_CHAT_ID,
                        f"âš  **Ù‡Ø´Ø¯Ø§Ø±: Ù…ØµØ±Ù RAM Ø¨Ø§Ù„Ø§ÛŒ Û¸Û°Ùª Ø¨Ø§Ù‚ÛŒ Ù…Ø§Ù†Ø¯Ù‡!**\nğŸ”¹ **RAM:** {ram_recheck}%"
                    )
                    high_usage_alert["ram"] = True  # Ø«Ø¨Øª Ù‡Ø´Ø¯Ø§Ø±
        else:
            high_usage_alert[
                "ram"] = False  # Ø§Ú¯Ø± RAM Ú©Ø§Ù‡Ø´ ÛŒØ§ÙØªØŒ Ù‡Ø´Ø¯Ø§Ø± Ø±Ø§ Ø±ÛŒØ³Øª Ú©Ù†

        LAST_USAGE["cpu"] = cpu_usage
        LAST_USAGE["ram"] = ram_usage

        time.sleep(60)  # Ù‡Ø± Û± Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø±Ø±Ø³ÛŒ Ø´ÙˆØ¯


threading.Thread(target=monitor_server, daemon=True).start()


# ğŸ”„ Ø§Ø¬Ø±Ø§ÛŒ Ø§ÛŒÙ…Ù† Ø±Ø¨Ø§Øª
def safe_polling():
    while True:
        try:
            bot.polling(none_stop=True, interval=15,
                        timeout=30)  # â¬… Ø§ÙØ²Ø§ÛŒØ´ timeout Ø¨Ø±Ø§ÛŒ Ú©Ø§Ù‡Ø´ Ù…ØµØ±Ù CPU
        except (ReadTimeout, ProxyError, ConnectionResetError):
            time.sleep(
                30)  # â¬… Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ú©Ø±Ø± Ø¯Ø± ØµÙˆØ±Øª Ù‚Ø·Ø¹ Ø´Ø¯Ù† Ø§Ø±ØªØ¨Ø§Ø·
        except Exception as e:
            notify_admin(
                f"âš ï¸ Ø®Ø·Ø§ÛŒ Ø¨Ø­Ø±Ø§Ù†ÛŒ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª:\n{traceback.format_exc()}")
            time.sleep(30)


# ğŸ“Œ ØªØ§Ø¨Ø¹ Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ Ø§Ø² main.py
def start_bot():
    # Ù…ØªØºÛŒØ± Ù…Ø­ÛŒØ·ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ¹ÛŒÛŒÙ† Ø­Ø§Ù„Øª Ø±Ø¨Ø§Øª: ÙˆØ¨â€ŒÙ‡ÙˆÚ© ÛŒØ§ polling
    # Ø­Ø§Ù„Øª polling Ø±Ø§ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ… ØªØ§ Ø±Ø¨Ø§Øª Ù‡Ù…ÛŒØ´Ù‡ Ø±ÙˆØ´Ù† Ø¨Ù…Ø§Ù†Ø¯
    WEBHOOK_MODE = False  # Ø¨Ù‡ Ø¬Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…ØªØºÛŒØ± Ù…Ø­ÛŒØ·ÛŒØŒ Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ false Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒØ¯Ù‡ÛŒÙ…

    if WEBHOOK_MODE:
        # ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ¨â€ŒÙ‡ÙˆÚ©
        try:
            # Ø¨Ø±Ø§ÛŒ Ø³Ø±ÙˆØ± Ø±ÛŒÙ„â€ŒÙˆÛŒØŒ Ø¢Ø¯Ø±Ø³ Ø¯Ø§Ù…Ù†Ù‡ Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            # Ø§Ø² Ø¢Ø¯Ø±Ø³ ÙˆØ§Ù‚Ø¹ÛŒ Ø³Ø±ÙˆØ± Ø±ÛŒÙ„â€ŒÙˆÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
            webhook_host = os.environ.get('DOMAIN_URL')

            if not webhook_host:
                webhook_host = "https://telegram-production-cc29.up.railway.app"

            print(f"ğŸ“Œ Ø¢Ø¯Ø±Ø³ ÙˆØ¨â€ŒÙ‡ÙˆÚ©: {webhook_host}")

            webhook_path = f"/{TOKEN}/"
            webhook_url = f"{webhook_host}{webhook_path}"

            print(f"ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ ØªÙ†Ø¸ÛŒÙ… ÙˆØ¨â€ŒÙ‡ÙˆÚ© Ø¨Ø§ Ø¢Ø¯Ø±Ø³: {webhook_host}")

            # Ø­Ø°Ù ÙˆØ¨â€ŒÙ‡ÙˆÚ© Ù‚Ø¨Ù„ÛŒ (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯)
            bot.remove_webhook()
            time.sleep(0.2)

            # ØªÙ†Ø¸ÛŒÙ… ÙˆØ¨â€ŒÙ‡ÙˆÚ© Ø¬Ø¯ÛŒØ¯ - Ø¨Ø¯ÙˆÙ† Ù†Ù…Ø§ÛŒØ´ ØªÙˆÚ©Ù† Ø¯Ø± Ù„Ø§Ú¯â€ŒÙ‡Ø§
            bot.set_webhook(url=webhook_url)
            masked_url = webhook_url.replace(TOKEN, "***TOKEN***")
            print(f"ğŸ”Œ ÙˆØ¨â€ŒÙ‡ÙˆÚ© Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± {masked_url} ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯")
            return True  # ÙˆØ¨â€ŒÙ‡ÙˆÚ© Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯
        except Exception as e:
            print(f"âš  Ø®Ø·Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ… ÙˆØ¨â€ŒÙ‡ÙˆÚ©: {e}")
            time.sleep(5)
            return False
    else:
        # Ø­Ø§Ù„Øª polling - Ø¨Ø±Ø§ÛŒ Ø²Ù…Ø§Ù†ÛŒ Ú©Ù‡ ÙˆØ¨â€ŒÙ‡ÙˆÚ© Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª
        while True:
            try:
                # Ø­Ø°Ù ÙˆØ¨â€ŒÙ‡ÙˆÚ© Ù‚Ø¨Ù„ÛŒ (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯)
                bot.remove_webhook()
                time.sleep(0.2)

                # Ø´Ø±ÙˆØ¹ polling
                print("ğŸ”„ Ø±Ø¨Ø§Øª Ø¯Ø± Ø­Ø§Ù„Øª polling Ø´Ø±ÙˆØ¹ Ø¨Ù‡ Ú©Ø§Ø± Ú©Ø±Ø¯")
                bot.polling(none_stop=True, interval=10, timeout=30)
            except Exception as e:
                print(f"âš  Ø®Ø·Ø§ÛŒ Ø¨Ø­Ø±Ø§Ù†ÛŒ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª:\n{e}")
                time.sleep(15)


if __name__ == "__main__":
    print("ğŸš€ Webhook ÙØ¹Ø§Ù„ Ø´Ø¯!")
    app.run(host="0.0.0.0", port=int(os.environ.get("PORT", 8080)))

