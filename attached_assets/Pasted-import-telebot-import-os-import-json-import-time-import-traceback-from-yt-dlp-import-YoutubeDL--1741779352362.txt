import telebot
import os
import json
import time
import traceback
from yt_dlp import YoutubeDL
from requests.exceptions import ReadTimeout, ProxyError, ConnectionError

# ğŸ”‘ ØªÙˆÚ©Ù† Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…
TOKEN = '7338644071:AAEex9j0nMualdoywHSGFiBoMAzRpkFypPk'
bot = telebot.TeleBot(TOKEN)

# ğŸ“¢ Ø¢ÛŒØ¯ÛŒ Ø¹Ø¯Ø¯ÛŒ Ø§Ø¯Ù…ÛŒÙ† Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø®Ø·Ø§Ù‡Ø§
ADMIN_CHAT_ID = 286420965  

# ğŸ“‚ Ù…Ø³ÛŒØ± Ø°Ø®ÛŒØ±Ù‡ ÙˆÛŒØ¯ÛŒÙˆÙ‡Ø§
VIDEO_FOLDER = "videos"
INSTAGRAM_FOLDER = "instagram_videos"
os.makedirs(VIDEO_FOLDER, exist_ok=True)
os.makedirs(INSTAGRAM_FOLDER, exist_ok=True)

# ğŸ“‚ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ÛŒ Ù…ØªÙ†ÛŒ
def load_responses():
    try:
        with open("responses.json", "r", encoding="utf-8") as file:
            return json.load(file)
    except FileNotFoundError:
        return {}

def save_responses():
    with open("responses.json", "w", encoding="utf-8") as file:
        json.dump(responses, file, ensure_ascii=False, indent=4)

responses = load_responses()

# ğŸ“Œ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… ÙˆÛŒØ¯ÛŒÙˆ Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ù†Ù„ÙˆØ¯
def get_direct_video_url(link):
    try:
        ydl_opts = {
            'quiet': True,
            'skip_download': True,
            'noplaylist': True,
            'force_generic_extractor': False,
            'format': 'best[ext=mp4]/best',
        }
        with YoutubeDL(ydl_opts) as ydl:
            info = ydl.extract_info(link, download=False)
            return info.get('url', None)
    except Exception as e:
        notify_admin(f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… ÙˆÛŒØ¯ÛŒÙˆ:\n{traceback.format_exc()}")
        return None

# ğŸ“Œ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆ Ø§Ø² Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…
def download_instagram(link):
    try:
        clear_folder(INSTAGRAM_FOLDER)  # Ø­Ø°Ù ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ

        ydl_opts = {
            'outtmpl': f'{INSTAGRAM_FOLDER}/%(id)s.%(ext)s',
            'format': 'mp4/best',
            'quiet': False,
            'noplaylist': True,
        }

        with YoutubeDL(ydl_opts) as ydl:
            info = ydl.extract_info(link, download=True)
            video_path = f"{INSTAGRAM_FOLDER}/{info['id']}.mp4"
            return video_path if os.path.exists(video_path) else None

    except Exception as e:
        notify_admin(f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆ Ø§Ø² Ø§ÛŒÙ†Ø³ØªØ§Ú¯Ø±Ø§Ù…:\n{traceback.format_exc()}")
        return None

# ğŸ“Œ Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆ Ø§Ø² ÛŒÙˆØªÛŒÙˆØ¨
def download_youtube(link):
    try:
        clear_folder(VIDEO_FOLDER)  # Ø­Ø°Ù ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒ

        ydl_opts = {
            'outtmpl': f'{VIDEO_FOLDER}/%(id)s.%(ext)s',
            'format': 'mp4/best',
            'quiet': False,
            'noplaylist': True,
        }

        with YoutubeDL(ydl_opts) as ydl:
            info = ydl.extract_info(link, download=True)
            video_path = f"{VIDEO_FOLDER}/{info['id']}.mp4"
            return video_path if os.path.exists(video_path) else None

    except Exception as e:
        notify_admin(f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙˆÛŒØ¯ÛŒÙˆ Ø§Ø² ÛŒÙˆØªÛŒÙˆØ¨:\n{traceback.format_exc()}")
        return None

# ğŸ“¢ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ† Ø¯Ø± ØµÙˆØ±Øª ÙˆÙ‚ÙˆØ¹ Ø®Ø·Ø§
def notify_admin(message):
    try:
        bot.send_message(ADMIN_CHAT_ID, message[:4000])
    except Exception as e:
        print(f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ù‡ Ø§Ø¯Ù…ÛŒÙ†: {e}")

# ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ¯ÛŒÙˆ ÛŒØ§ ÙØ§ÛŒÙ„ Ø¨Ù‡ Ú©Ø§Ø±Ø¨Ø±
def send_video_with_handling(chat_id, video_path):
    try:
        file_size = os.path.getsize(video_path) / (1024 * 1024)  # Ø§Ù†Ø¯Ø§Ø²Ù‡ ÙØ§ÛŒÙ„ Ø¨Ù‡ Ù…Ú¯Ø§Ø¨Ø§ÛŒØª

        with open(video_path, 'rb') as video:
            if file_size > 50:  # Ø§Ú¯Ø± ÙØ§ÛŒÙ„ Ø¨ÛŒØ´ Ø§Ø² 50MB Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ù‡â€ŒØµÙˆØ±Øª ÙØ§ÛŒÙ„ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†
                bot.send_document(chat_id=chat_id, document=video, timeout=120)
            else:
                bot.send_video(chat_id=chat_id, video=video, timeout=120)

    except (ConnectionResetError, ConnectionError):
        bot.send_message(chat_id, "âš ï¸ Ø§ØªØµØ§Ù„ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù… Ù‚Ø·Ø¹ Ø´Ø¯ØŒ Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.")
    except Exception as e:
        notify_admin(f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ¯ÛŒÙˆ:\n{traceback.format_exc()}")
        bot.send_message(chat_id, "âš ï¸ Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ¯ÛŒÙˆ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.")

# ğŸ“© Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØªÛŒ
@bot.message_handler(func=lambda message: True)
def handle_message(message):
    try:
        text = message.text.strip()

        if "instagram.com" in text or "youtube.com" in text or "youtu.be" in text:
            # Ø§Ø¨ØªØ¯Ø§ Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… Ø±Ø§ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†
            direct_url = get_direct_video_url(text)
            if direct_url:
                bot.send_video(chat_id=message.chat.id, video=direct_url)
            else:
                # Ø§Ú¯Ø± Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ… Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ùˆ Ø§Ø±Ø³Ø§Ù„ ÙˆÛŒØ¯ÛŒÙˆ Ø§Ù†Ø¬Ø§Ù… Ø´ÙˆØ¯
                video_path = download_instagram(text) if "instagram.com" in text else download_youtube(text)
                if video_path and os.path.exists(video_path):
                    send_video_with_handling(message.chat.id, video_path)
                else:
                    bot.reply_to(message, "âš ï¸ ÙˆÛŒØ¯ÛŒÙˆÛŒ Ù…ÙˆØ±Ø¯Ù†Ø¸Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù†Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ù„ÛŒÙ†Ú© Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.")

        elif "ØŒ" in text:
            try:
                question, answer = map(str.strip, text.split("ØŒ", 1))
                responses[question.lower()] = answer
                save_responses()
                bot.reply_to(message, f"âœ… Ø³ÙˆØ§Ù„ '{question}' Ø¨Ø§ Ù¾Ø§Ø³Ø® '{answer}' Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯!")
            except ValueError:
                bot.reply_to(message, "âš ï¸ Ù„Ø·ÙØ§Ù‹ ÙØ±Ù…Øª 'Ø³ÙˆØ§Ù„ØŒ Ø¬ÙˆØ§Ø¨' Ø±Ø§ Ø±Ø¹Ø§ÛŒØª Ú©Ù†ÛŒØ¯.")

        else:
            key = text.lower()
            if key in responses:
                bot.reply_to(message, responses[key])
            else:
                bot.reply_to(message, "ğŸ¤– Ø³ÙˆØ§Ù„ÛŒ Ú©Ù‡ Ù¾Ø±Ø³ÛŒØ¯ÛŒ Ø¯Ø± Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ù…Ù† Ù†ÛŒØ³Øª.")

    except Exception as e:
        notify_admin(f"âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù¾ÛŒØ§Ù…:\n{traceback.format_exc()}")

# ğŸ”„ Ø§Ø¬Ø±Ø§ÛŒ Ø§ÛŒÙ…Ù† Ø±Ø¨Ø§Øª
def safe_polling():
    while True:
        try:
            bot.polling(none_stop=True, interval=1)
        except (ReadTimeout, ProxyError, ConnectionResetError):
            time.sleep(15)
        except Exception as e:
            notify_admin(f"âš ï¸ Ø®Ø·Ø§ÛŒ Ø¨Ø­Ø±Ø§Ù†ÛŒ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ Ø¨Ø§Øª:\n{traceback.format_exc()}")
            time.sleep(15)

if __name__ == "__main__":
    print("ğŸ¤– Bot is running...")
    safe_polling()
